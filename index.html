<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Analyzer - 3-Step Interactive Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .input-section {
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .step-container {
            display: none;
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .step-title {
            font-size: 1.5em;
            color: #1a202c;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
        }

        .comment-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .comment-card {
            background: #f9fafb;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .comment-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #718096;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
        }

        .comment-score {
            color: #38a169;
        }

        .comment-body {
            color: #2d3748;
            white-space: pre-wrap;
        }

        .recommendations-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .recommendation-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recommendation-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .recommendation-card.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .recommendation-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recommendation-card.unavailable:hover {
            border-color: #e2e8f0;
            box-shadow: none;
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .recommendation-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #1a202c;
        }

        .recommendation-desc {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .recommendation-data {
            font-size: 0.85em;
            color: #48bb78;
            font-weight: 500;
        }

        .recommendation-estimate {
            font-size: 0.8em;
            color: #667eea;
            font-style: italic;
        }

        .insights-container {
            display: none;
            padding: 30px;
        }

        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .insight-type {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .insight-text {
            font-size: 1.1em;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .collapse-btn {
            background: #cbd5e0;
            color: #2d3748;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .collapse-btn:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Reddit Analyzer</h1>
            <p>3-Step Interactive Analysis - Extract ‚Üí Recommend ‚Üí Analyze</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="redditUrl" placeholder="Paste Reddit post URL here..." value="https://www.reddit.com/r/AskReddit/comments/1hqxo9o/what_industry_is_quietly_booming_right_now_but/">
                <button class="btn" onclick="startAnalysis()">Step 1: Extract Content</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingMessage">Extracting valuable content...</p>
        </div>

        <!-- STEP 1: Extracted Content -->
        <div class="step-container" id="step1Container">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Valuable Content Extracted</div>
            </div>

            <div class="stats-grid" id="extractionStats"></div>

            <div class="comment-list" id="commentList"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="proceedToStep2()">Step 2: Analyze & Recommend ‚Üí</button>
                <button class="btn" onclick="exportToPDF()" style="background: #ed8936;">üìÑ Export as PDF</button>
                <button class="btn collapse-btn" onclick="collapseStep('step1Container')">Collapse</button>
            </div>
        </div>

        <!-- STEP 2: Recommendations -->
        <div class="step-container" id="step2Container">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Available Analyses</div>
            </div>

            <p style="margin-bottom: 20px; color: #718096;">
                Based on the extracted content, here are the analyses we can run. Select which insights you want to generate:
            </p>

            <div class="recommendations-grid" id="recommendationsGrid"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="proceedToStep3()" id="generateBtn" disabled>
                    Step 3: Generate Selected Insights ‚Üí
                </button>
                <button class="btn collapse-btn" onclick="collapseStep('step2Container')">Collapse</button>
            </div>
        </div>

        <!-- STEP 3: Insights -->
        <div class="insights-container" id="insightsContainer">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Strategic Insights</div>
            </div>

            <div id="insightsList"></div>

            <div class="action-buttons">
                <button class="btn" onclick="startNewAnalysis()">Analyze Another Post</button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script web app URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwLPQgHXv8RFFYDQS_eoEMoTOQp8gptNIUi9wJgvC-wK9WQI5XHn8yAVaH95WZR9WsP/exec';

        let extractedData = null;
        let selectedAnalyses = new Set();

        function startAnalysis() {
            const url = document.getElementById('redditUrl').value.trim();
            if (!url) {
                alert('Please enter a Reddit URL');
                return;
            }

            // Reset
            document.getElementById('step1Container').style.display = 'none';
            document.getElementById('step2Container').style.display = 'none';
            document.getElementById('insightsContainer').style.display = 'none';
            extractedData = null;
            selectedAnalyses.clear();

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Extracting valuable content from comments...';

            // Call Step 1: Extract
            const callbackName = 'callback_' + Date.now();
            window[callbackName] = function(response) {
                document.getElementById('loading').style.display = 'none';

                if (response.success) {
                    extractedData = response.data;
                    displayStep1(response.data);
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }

                delete window[callbackName];
            };

            const scriptElement = document.createElement('script');
            scriptElement.src = `${SCRIPT_URL}?url=${encodeURIComponent(url)}&mode=step1_extract&callback=${callbackName}`;
            document.body.appendChild(scriptElement);
        }

        function displayStep1(data) {
            const container = document.getElementById('step1Container');
            container.style.display = 'block';

            // Display post title
            const postTitle = document.createElement('div');
            postTitle.style.cssText = 'background: #eef2ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;';
            postTitle.innerHTML = `
                <div style="font-size: 1.2em; font-weight: 600; color: #1a202c; margin-bottom: 10px;">
                    üìÑ ${escapeHtml(data.post.title)}
                </div>
                <div style="font-size: 0.9em; color: #718096;">
                    Posted by u/${escapeHtml(data.post.author)} ‚Ä¢ ${data.post.score} upvotes ‚Ä¢ ${data.post.num_comments} comments
                </div>
            `;
            document.getElementById('step1Container').insertBefore(postTitle, document.getElementById('extractionStats'));

            // Display stats
            const stats = data.extractionStats;
            document.getElementById('extractionStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Comments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.extracted}</div>
                    <div class="stat-label">High-Value Extracted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.percentageKept}%</div>
                    <div class="stat-label">Kept</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.averageScore}</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            `;

            // Display comments
            const commentList = document.getElementById('commentList');
            commentList.innerHTML = data.valuableComments.map(comment => `
                <div class="comment-card">
                    <div class="comment-meta">
                        <span class="comment-author">üë§ u/${escapeHtml(comment.author)}</span>
                        <span class="comment-score">‚¨ÜÔ∏è ${comment.score}</span>
                        ${comment.awards > 0 ? `<span>üèÜ ${comment.awards}</span>` : ''}
                    </div>
                    <div class="comment-body">${escapeHtml(comment.body.substring(0, 400))}${comment.body.length > 400 ? '...' : ''}</div>
                </div>
            `).join('');

            // Scroll to step 1
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function proceedToStep2() {
            if (!extractedData) return;

            // Run analysis in the browser - no backend call needed!
            const recommendations = analyzeAndRecommendInBrowser(extractedData);
            displayStep2(recommendations);
        }

        function analyzeAndRecommendInBrowser(contentData) {
            const comments = contentData.valuableComments || [];
            const recommendations = [];

            // 1. Entity & Topic Analysis
            const entities = {};
            comments.forEach(c => {
                const matches = (c.body || '').match(/\b[A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){0,3}\b/g) || [];
                matches.forEach(e => {
                    if (e.length > 3) entities[e] = (entities[e] || 0) + 1;
                });
            });
            const topEntities = Object.entries(entities).filter(([_, count]) => count >= 3).length;
            if (topEntities > 0) {
                recommendations.push({
                    id: 'entity_analysis',
                    name: 'Entity & Topic Analysis',
                    description: 'Identify most discussed industries, products, or topics with sentiment',
                    available: true,
                    dataFound: `${topEntities} entities mentioned 3+ times`,
                    estimatedInsights: Math.min(topEntities, 10)
                });
            }

            // 2. Success/Failure Rate Analysis
            const successCount = comments.filter(c => /\b(worked|success|helped|fixed|cured|solved|great|amazing)\b/i.test(c.body)).length;
            const failureCount = comments.filter(c => /\b(failed|didn't work|worse|useless|no help|terrible|awful)\b/i.test(c.body)).length;
            if (successCount + failureCount >= 10) {
                recommendations.push({
                    id: 'outcome_analysis',
                    name: 'Success/Failure Rate Analysis',
                    description: 'Calculate success rates and effectiveness',
                    available: true,
                    dataFound: `${successCount} success + ${failureCount} failure mentions`,
                    estimatedInsights: 3
                });
            }

            // 3. Expert vs Experience Mix
            const expertCount = comments.filter(c => /\b(I work|professional|doctor|engineer|specialist|expert)\b/i.test(c.body)).length;
            const experienceCount = comments.filter(c => /\b(I |my |me |I've|I'm|personally)\b/i.test(c.body)).length;
            if (expertCount >= 5 || experienceCount >= 20) {
                recommendations.push({
                    id: 'speaker_analysis',
                    name: 'Expert vs Personal Experience Mix',
                    description: 'Balance between professional advice and lived experiences',
                    available: true,
                    dataFound: `${expertCount} expert comments, ${experienceCount} personal experiences`,
                    estimatedInsights: 2
                });
            }

            // 4. Pricing/Cost Analysis
            const priceCount = comments.filter(c => /\$[\d,]+|\bcost\b|\bprice\b|\bexpensive\b|\bcheap\b|\baffordable\b/i.test(c.body)).length;
            if (priceCount >= 10) {
                recommendations.push({
                    id: 'pricing_analysis',
                    name: 'Pricing & Cost Analysis',
                    description: 'Price sensitivity and value perception',
                    available: true,
                    dataFound: `${priceCount} comments mention pricing/cost`,
                    estimatedInsights: 3
                });
            }

            // 5. Timeline Expectations
            const timeCount = comments.filter(c => /\b(immediate|instant|days?|weeks?|months?|years?|long.?term|short.?term)\b/i.test(c.body)).length;
            if (timeCount >= 10) {
                recommendations.push({
                    id: 'timeline_analysis',
                    name: 'Timeline Expectations',
                    description: 'How long things take based on community experiences',
                    available: true,
                    dataFound: `${timeCount} comments mention timeframes`,
                    estimatedInsights: 2
                });
            }

            return {
                totalRecommendations: recommendations.length,
                availableAnalyses: recommendations.length,
                recommendations: recommendations
            };
        }

        function displayStep2(data) {
            const container = document.getElementById('step2Container');
            container.style.display = 'block';

            const grid = document.getElementById('recommendationsGrid');
            grid.innerHTML = data.recommendations.map(rec => `
                <div class="recommendation-card ${rec.available ? '' : 'unavailable'}"
                     onclick="${rec.available ? `toggleAnalysis('${rec.id}')` : ''}"
                     id="rec_${rec.id}">
                    <div class="recommendation-header">
                        ${rec.available ? `<input type="checkbox" class="checkbox" id="check_${rec.id}" onchange="updateSelection()">` : ''}
                        <div class="recommendation-title">${rec.available ? '‚úì' : '‚úó'} ${escapeHtml(rec.name)}</div>
                    </div>
                    <div class="recommendation-desc">${escapeHtml(rec.description)}</div>
                    <div class="recommendation-data">üìä ${escapeHtml(rec.dataFound)}</div>
                    ${rec.available ? `<div class="recommendation-estimate">~${rec.estimatedInsights} insights expected</div>` : ''}
                </div>
            `).join('');

            // Scroll to step 2
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function toggleAnalysis(analysisId) {
            const checkbox = document.getElementById('check_' + analysisId);
            const card = document.getElementById('rec_' + analysisId);

            if (checkbox.checked) {
                selectedAnalyses.delete(analysisId);
                checkbox.checked = false;
                card.classList.remove('selected');
            } else {
                selectedAnalyses.add(analysisId);
                checkbox.checked = true;
                card.classList.add('selected');
            }

            updateSelection();
        }

        function updateSelection() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = selectedAnalyses.size === 0;
            btn.textContent = `Step 3: Generate ${selectedAnalyses.size} Selected Insight${selectedAnalyses.size !== 1 ? 's' : ''} ‚Üí`;
        }

        function proceedToStep3() {
            if (selectedAnalyses.size === 0 || !extractedData) return;

            // Run insights generation in the browser - no backend call!
            const insights = generateInsightsInBrowser(extractedData, Array.from(selectedAnalyses));
            displayStep3({insights: insights, totalInsights: insights.length, selectedAnalyses: Array.from(selectedAnalyses)});
        }

        function generateInsightsInBrowser(contentData, selectedAnalyses) {
            const comments = contentData.valuableComments || [];
            const insights = [];

            // Stopwords for entity extraction
            const stopwords = new Set(['The', 'This', 'That', 'These', 'Those', 'They', 'There', 'What', 'When', 'Where', 'Every', 'Each', 'Some', 'Many', 'More', 'Most', 'From', 'With', 'Reddit', 'Edit', 'Update', 'People', 'Data']);

            selectedAnalyses.forEach(analysisId => {
                if (analysisId === 'entity_analysis') {
                    // Entity & Topic Analysis
                    const entities = {};
                    const basePosWords = ['good', 'great', 'love', 'best', 'worked', 'helped', 'success', 'amazing', 'booming', 'growing'];
                    const baseNegWords = ['bad', 'terrible', 'hate', 'worst', 'failed', 'useless', 'awful', 'dying', 'declining'];

                    comments.forEach(c => {
                        const body = c.body || '';
                        const matches = body.match(/\b[A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){0,3}\b/g) || [];
                        matches.forEach(entity => {
                            if (entity.length > 3 && !stopwords.has(entity)) {
                                if (!entities[entity]) entities[entity] = {count: 0, pos: 0, neg: 0, neu: 0};
                                entities[entity].count++;

                                const idx = body.indexOf(entity);
                                const context = body.substring(Math.max(0, idx - 60), Math.min(body.length, idx + entity.length + 60)).toLowerCase();
                                if (basePosWords.some(w => context.includes(w))) entities[entity].pos++;
                                else if (baseNegWords.some(w => context.includes(w))) entities[entity].neg++;
                                else entities[entity].neu++;
                            }
                        });
                    });

                    const topEntities = Object.entries(entities)
                        .filter(([_, data]) => data.count >= 3)
                        .sort((a, b) => b[1].count - a[1].count)
                        .slice(0, 10);

                    topEntities.forEach(([entity, data]) => {
                        const total = data.pos + data.neg + data.neu;
                        const sentiment = total > 0 ? Math.round((data.pos / total) * 100) : 0;
                        const percentage = Math.round((data.count / comments.length) * 100);

                        let sentimentText = '';
                        if (sentiment >= 70) sentimentText = ` with ${sentiment}% positive sentiment - highly favored`;
                        else if (sentiment <= 30 && sentiment > 0) sentimentText = ` with only ${sentiment}% positive sentiment - concerns noted`;

                        insights.push({
                            type: 'entity_analysis',
                            insight: `"${entity}" discussed in ${percentage}% of comments (${data.count} mentions)${sentimentText}`
                        });
                    });
                }

                if (analysisId === 'outcome_analysis') {
                    const worked = comments.filter(c => /\b(worked|success|helped|fixed|cured|solved)\b/i.test(c.body)).length;
                    const failed = comments.filter(c => /\b(failed|didn't work|worse|useless|no help)\b/i.test(c.body)).length;
                    const total = worked + failed;

                    if (total >= 10) {
                        const successRate = Math.round((worked / total) * 100);
                        let interpretation = successRate >= 70 ? 'highly effective' : successRate >= 50 ? 'moderately effective' : successRate >= 30 ? 'mixed results' : 'low success rate';

                        insights.push({
                            type: 'outcome_analysis',
                            insight: `${successRate}% success rate across reported attempts (${worked} worked vs ${failed} failed) - ${interpretation}`
                        });
                    }
                }

                if (analysisId === 'speaker_analysis') {
                    const expertCount = comments.filter(c => /\b(I work|professional|doctor|engineer|specialist|expert)\b/i.test(c.body)).length;
                    const experienceCount = comments.filter(c => /\b(I |my |me |I've|I'm|personally)\b/i.test(c.body)).length;
                    const expertPct = Math.round((expertCount / comments.length) * 100);
                    const experiencePct = Math.round((experienceCount / comments.length) * 100);

                    let insight = expertPct >= 20 ?
                        `${expertPct}% expert/professional input, ${experiencePct}% firsthand experiences - balanced perspectives` :
                        `${experiencePct}% firsthand personal experiences - highly authentic discussion`;

                    insights.push({type: 'speaker_analysis', insight: insight});
                }

                if (analysisId === 'pricing_analysis') {
                    const priceComments = comments.filter(c => /\$[\d,]+|\bcost\b|\bprice\b|\bexpensive\b|\bcheap\b|\baffordable\b/i.test(c.body));
                    const expensiveMentions = priceComments.filter(c => /\bexpensive\b|\bpricey\b|\bcost\b|\$[\d,]{3,}/i.test(c.body)).length;
                    const cheapMentions = priceComments.filter(c => /\bcheap\b|\baffordable\b|\bbudget\b/i.test(c.body)).length;
                    const pricePct = Math.round((priceComments.length / comments.length) * 100);

                    insights.push({
                        type: 'pricing_analysis',
                        insight: `Price discussed in ${pricePct}% of comments - ${expensiveMentions > cheapMentions ? 'Quality over price' : 'Budget-conscious'} audience`
                    });
                }

                if (analysisId === 'timeline_analysis') {
                    const timeMentions = {};
                    const timePatterns = {
                        'immediate': /\b(immediately|instant|right away|same day)\b/i,
                        'days': /\b(days?|few days|couple days)\b/i,
                        'weeks': /\b(weeks?|few weeks)\b/i,
                        'months': /\b(months?|several months)\b/i,
                        'years': /\b(years?|long time|forever)\b/i
                    };

                    comments.forEach(c => {
                        Object.entries(timePatterns).forEach(([timeline, pattern]) => {
                            if (pattern.test(c.body)) timeMentions[timeline] = (timeMentions[timeline] || 0) + 1;
                        });
                    });

                    const dominant = Object.entries(timeMentions).sort((a, b) => b[1] - a[1])[0];
                    if (dominant && dominant[1] >= 3) {
                        const pct = Math.round((dominant[1] / comments.length) * 100);
                        insights.push({
                            type: 'timeline_analysis',
                            insight: `Most common timeline: "${dominant[0]}" (${pct}% of comments) - sets realistic expectations`
                        });
                    }
                }
            });

            return insights;
        }

        function displayStep3(data) {
            const container = document.getElementById('insightsContainer');
            container.style.display = 'block';

            const list = document.getElementById('insightsList');
            list.innerHTML = data.insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-type">${escapeHtml(insight.type.replace(/_/g, ' '))}</div>
                    <div class="insight-text">üí° ${escapeHtml(insight.insight)}</div>
                </div>
            `).join('');

            if (data.insights.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No insights generated. Try selecting different analyses.</p>';
            }

            // Scroll to insights
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function collapseStep(stepId) {
            document.getElementById(stepId).style.display = 'none';
        }

        function startNewAnalysis() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('redditUrl').value = '';
            document.getElementById('redditUrl').focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function exportToPDF() {
            if (!extractedData) {
                alert('No data to export');
                return;
            }

            // Create a new window for PDF export
            const printWindow = window.open('', '', 'width=800,height=600');

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${escapeHtml(extractedData.post.title)}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        h1 {
                            color: #667eea;
                            font-size: 1.5em;
                            margin-bottom: 10px;
                        }
                        .meta {
                            color: #666;
                            font-size: 0.9em;
                            margin-bottom: 20px;
                        }
                        .stats {
                            background: #f5f5f5;
                            padding: 15px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                        }
                        .stat {
                            text-align: center;
                        }
                        .stat-value {
                            font-size: 1.5em;
                            font-weight: bold;
                            color: #667eea;
                        }
                        .stat-label {
                            font-size: 0.85em;
                            color: #666;
                        }
                        .comment {
                            border-left: 3px solid #667eea;
                            padding: 15px;
                            margin-bottom: 15px;
                            background: #f9f9f9;
                            page-break-inside: avoid;
                        }
                        .comment-meta {
                            font-size: 0.9em;
                            color: #666;
                            margin-bottom: 8px;
                        }
                        .comment-author {
                            font-weight: bold;
                            color: #667eea;
                        }
                        .comment-score {
                            color: #48bb78;
                            margin-left: 10px;
                        }
                        .comment-body {
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            color: #999;
                            font-size: 0.85em;
                        }
                        @media print {
                            body { margin: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìÑ ${escapeHtml(extractedData.post.title)}</h1>
                        <div class="meta">
                            Posted by u/${escapeHtml(extractedData.post.author)} ‚Ä¢
                            ${extractedData.post.score} upvotes ‚Ä¢
                            ${extractedData.post.num_comments} comments
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stats-grid">
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.total}</div>
                                <div class="stat-label">Total Comments</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.extracted}</div>
                                <div class="stat-label">High-Value Extracted</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.percentageKept}%</div>
                                <div class="stat-label">Kept</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.averageScore}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                        </div>
                    </div>

                    <h2 style="color: #667eea; margin-bottom: 15px;">Valuable Comments (${extractedData.valuableComments.length})</h2>

                    ${extractedData.valuableComments.map((comment, index) => `
                        <div class="comment">
                            <div class="comment-meta">
                                <span class="comment-author">#${index + 1} ‚Ä¢ u/${escapeHtml(comment.author)}</span>
                                <span class="comment-score">‚¨ÜÔ∏è ${comment.score}</span>
                                ${comment.awards > 0 ? `<span>üèÜ ${comment.awards}</span>` : ''}
                            </div>
                            <div class="comment-body">${escapeHtml(comment.body)}</div>
                        </div>
                    `).join('')}

                    <div class="footer">
                        Generated by Reddit Analyzer ‚Ä¢ ${new Date().toLocaleString()}
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();

            // Wait for content to load, then trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
    </script>
</body>
</html>
