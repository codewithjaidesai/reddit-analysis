<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Analyzer - 3-Step Interactive Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .input-section {
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 15px 30px;
            font-size: 1em;
            color: #718096;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f7fafc;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        /* Post Cards */
        .post-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .post-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .post-card.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .post-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 15px;
        }

        .post-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .post-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.9em;
            color: #718096;
            margin-bottom: 10px;
        }

        .post-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .engagement-stars {
            color: #f59e0b;
            font-size: 1.1em;
            letter-spacing: 2px;
        }

        .post-preview {
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            line-height: 1.5;
        }

        .post-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .post-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9em;
            padding: 5px 10px;
            border: 1px solid #667eea;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .post-link:hover {
            background: #667eea;
            color: white;
        }

        .step-container {
            display: none;
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .step-title {
            font-size: 1.5em;
            color: #1a202c;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
        }

        .comment-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .comment-card {
            background: #f9fafb;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .comment-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #718096;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
        }

        .comment-score {
            color: #38a169;
        }

        .comment-body {
            color: #2d3748;
            white-space: pre-wrap;
        }

        .recommendations-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .recommendation-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recommendation-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .recommendation-card.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .recommendation-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recommendation-card.unavailable:hover {
            border-color: #e2e8f0;
            box-shadow: none;
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .recommendation-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #1a202c;
        }

        .recommendation-desc {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .recommendation-data {
            font-size: 0.85em;
            color: #48bb78;
            font-weight: 500;
        }

        .recommendation-estimate {
            font-size: 0.8em;
            color: #667eea;
            font-style: italic;
        }

        .insights-container {
            display: none;
            padding: 30px;
        }

        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .insight-type {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .insight-text {
            font-size: 1.1em;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .collapse-btn {
            background: #cbd5e0;
            color: #2d3748;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .collapse-btn:hover {
            background: #a0aec0;
        }

        /* Data Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #2d3748;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background: #f7fafc;
        }

        .data-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tbody tr:nth-child(even):hover {
            background: #f0f2f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Reddit Analyzer</h1>
            <p>Discover & Analyze High-Engagement Reddit Content</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('topic')">
                üîç Search by Topic
            </button>
            <button class="tab-btn" onclick="switchTab('subreddit')">
                üìä Analyze Subreddit
            </button>
            <button class="tab-btn" onclick="switchTab('url')">
                üîó Analyze Single URL
            </button>
        </div>

        <!-- Diagnostic Section -->
        <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin: 20px; border-radius: 8px;">
            <strong style="color: #856404;">üîß Diagnostic Tools</strong>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button onclick="testBackend()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Test Backend
                </button>
                <button onclick="testAuth()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Test OAuth
                </button>
            </div>
            <div id="diagnosticResults" style="margin-top: 10px; font-size: 0.9em; color: #856404;"></div>
        </div>

        <!-- Topic Search Tab -->
        <div class="input-section" id="topicTab">
            <div class="search-form">
                <div class="input-group">
                    <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                        What topic are you researching?
                    </label>
                    <input type="text" id="topicInput" placeholder="e.g., AI and machine learning, climate change, startup advice..." style="width: 100%;">
                </div>

                <div style="margin-top: 15px; padding: 15px; background: #f7fafc; border-radius: 8px;">
                    <label style="display: flex; align-items: center; cursor: pointer; color: #4a5568; font-weight: 500;">
                        <input type="checkbox" id="subredditFilter" onchange="toggleSubredditInput()" style="margin-right: 10px;">
                        üéØ Search specific subreddits only
                    </label>
                    <div id="subredditInputDiv" style="display: none; margin-top: 10px;">
                        <input type="text" id="subredditInput" placeholder="e.g., MachineLearning, artificial, OpenAI" style="width: 100%;">
                        <small style="color: #718096;">Comma-separated, no r/ prefix</small>
                    </div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 15px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-size: 0.9em;">Time Range</label>
                        <select id="timeRange" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                            <option value="day">Last 24 hours</option>
                            <option value="week" selected>Last 7 days</option>
                            <option value="month">Last 30 days</option>
                            <option value="year">Last year</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-size: 0.9em;">Max Results</label>
                        <select id="maxResults" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                            <option value="10">Top 10</option>
                            <option value="15" selected>Top 15</option>
                            <option value="25">Top 25</option>
                        </select>
                    </div>
                    <button class="btn" onclick="searchByTopic()" style="flex-shrink: 0; white-space: nowrap;">
                        üîç Search Reddit
                    </button>
                </div>
            </div>

            <!-- Search Results -->
            <div id="searchResults" style="display: none; margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin: 0;">Search Results</h3>
                    <div id="searchResultsSummary" style="color: #718096; font-size: 0.9em;"></div>
                </div>
                <div id="postsList"></div>
                <div id="selectedPostsActions" style="display: none; margin-top: 20px; padding: 20px; background: #eef2ff; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #667eea; font-size: 1.1em;" id="selectedCount">0 posts selected</strong>
                            <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9em;">Choose how to analyze selected posts</p>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="analysisMode" value="separate" checked style="margin-right: 8px;">
                                <span style="color: #4a5568;">Analyze Separately</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="analysisMode" value="combine" style="margin-right: 8px;">
                                <span style="color: #4a5568;">Combine All</span>
                            </label>
                            <button class="btn" onclick="extractSelectedPosts()" style="font-size: 1.1em; padding: 15px 30px;">
                                üìä Extract & Analyze
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subreddit Analysis Tab -->
        <div class="input-section" id="subredditTab" style="display: none;">
            <div class="search-form">
                <div class="input-group">
                    <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                        Which subreddit do you want to analyze?
                    </label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #667eea; font-size: 1.2em; font-weight: 600;">r/</span>
                        <input type="text" id="subredditName" placeholder="e.g., MachineLearning, startups, fitness" style="flex: 1;">
                    </div>
                    <small style="display: block; margin-top: 5px; color: #718096;">Enter subreddit name without the r/ prefix</small>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 15px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-size: 0.9em;">Time Range</label>
                        <select id="subredditTimeRange" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                            <option value="day">Last 24 hours</option>
                            <option value="week" selected>Last 7 days</option>
                            <option value="month">Last 30 days</option>
                            <option value="year">Last year</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; margin-bottom: 5px; color: #4a5568; font-size: 0.9em;">Max Results</label>
                        <select id="subredditMaxResults" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1em;">
                            <option value="10">Top 10</option>
                            <option value="15" selected>Top 15</option>
                            <option value="25">Top 25</option>
                        </select>
                    </div>
                    <button class="btn" onclick="searchSubreddit()" style="flex-shrink: 0; white-space: nowrap;">
                        üìä Get Top Posts
                    </button>
                </div>
            </div>

            <!-- Search Results (reuse same structure) -->
            <div id="subredditResults" style="display: none; margin-top: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #667eea; margin: 0;">Top Posts</h3>
                    <div id="subredditResultsSummary" style="color: #718096; font-size: 0.9em;"></div>
                </div>
                <div id="subredditPostsList"></div>
                <div id="subredditSelectedPostsActions" style="display: none; margin-top: 20px; padding: 20px; background: #eef2ff; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #667eea; font-size: 1.1em;" id="subredditSelectedCount">0 posts selected</strong>
                            <p style="margin: 5px 0 0 0; color: #718096; font-size: 0.9em;">Choose how to analyze selected posts</p>
                        </div>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="subredditAnalysisMode" value="separate" checked style="margin-right: 8px;">
                                <span style="color: #4a5568;">Analyze Separately</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="subredditAnalysisMode" value="combine" style="margin-right: 8px;">
                                <span style="color: #4a5568;">Combine All</span>
                            </label>
                            <button class="btn" onclick="extractSubredditSelectedPosts()" style="font-size: 1.1em; padding: 15px 30px;">
                                üìä Extract & Analyze
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Single URL Tab -->
        <div class="input-section" id="urlTab" style="display: none;">
            <div class="input-group">
                <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 500;">
                    Paste Reddit Post URL
                </label>
                <input type="text" id="redditUrl" placeholder="https://www.reddit.com/r/subreddit/comments/..." value="">
                <button class="btn" onclick="startAnalysis()" style="margin-top: 10px;">Step 1: Extract Content</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingMessage">Extracting valuable content...</p>
        </div>

        <!-- STEP 1: Extracted Content -->
        <div class="step-container" id="step1Container">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Valuable Content Extracted</div>
            </div>

            <div class="stats-grid" id="extractionStats"></div>

            <div class="comment-list" id="commentList"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="proceedToStep2()">Step 2: Analyze & Recommend ‚Üí</button>
                <button class="btn" onclick="exportToPDF()" style="background: #ed8936;">üìÑ Export as PDF</button>
                <button class="btn" onclick="downloadForClaude(event)" style="background: #48bb78;">üíæ Download for Claude</button>
                <button class="btn" onclick="copyForClaude(event)" style="background: #9f7aea;">üìã Copy for Claude</button>
                <button class="btn collapse-btn" onclick="collapseStep('step1Container')">Collapse</button>
            </div>
        </div>

        <!-- STEP 2: Recommendations -->
        <div class="step-container" id="step2Container">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Available Analyses</div>
            </div>

            <p style="margin-bottom: 20px; color: #718096;">
                Based on the extracted content, here are the analyses we can run. Select which insights you want to generate:
            </p>

            <div class="recommendations-grid" id="recommendationsGrid"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="proceedToStep3()" id="generateBtn" disabled>
                    Step 3: Generate Selected Insights ‚Üí
                </button>
                <button class="btn collapse-btn" onclick="collapseStep('step2Container')">Collapse</button>
            </div>
        </div>

        <!-- STEP 3: Insights -->
        <div class="insights-container" id="insightsContainer">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Strategic Insights</div>
            </div>

            <div id="insightsList"></div>

            <div class="action-buttons">
                <button class="btn" onclick="startNewAnalysis()">Analyze Another Post</button>
            </div>
        </div>

        <!-- MULTI-POST EXTRACTION RESULTS -->
        <div id="multiPostContainer" style="display: none; padding: 30px;">
            <div style="margin-bottom: 30px;">
                <h2 style="color: #667eea; font-size: 2em; margin: 0 0 20px 0;" id="multiPostTitle">üìä Extracting Posts</h2>
                <div id="multiPostProgress" style="background: #eef2ff; padding: 20px; border-radius: 12px; border: 2px solid #c7d2fe;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #4c1d95; font-size: 1.1em;">Progress: <span id="progressText">Starting...</span></div>
                    <div style="background: #cbd5e0; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="progressBar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>
            <div id="multiPostResults" style="margin-bottom: 30px;"></div>
            <div id="multiPostActions" style="display: none; text-align: center; margin-top: 30px;">
                <button onclick="backToSearch()" style="background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600;">
                    ‚Üê Back to Search
                </button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script web app URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwLPQgHXv8RFFYDQS_eoEMoTOQp8gptNIUi9wJgvC-wK9WQI5XHn8yAVaH95WZR9WsP/exec';

        let extractedData = null;
        let selectedAnalyses = new Set();
        let searchResults = [];
        let selectedPosts = new Set();

        // ========================================================================
        // DIAGNOSTIC FUNCTIONS
        // ========================================================================

        function testBackend() {
            const resultsDiv = document.getElementById('diagnosticResults');
            resultsDiv.innerHTML = '‚è≥ Testing backend connection...';

            google.script.run
                .withSuccessHandler(function(result) {
                    resultsDiv.innerHTML = `‚úÖ ${result.message}<br>Timestamp: ${result.timestamp}`;
                    resultsDiv.style.color = '#155724';
                    resultsDiv.style.background = '#d4edda';
                    resultsDiv.style.padding = '10px';
                    resultsDiv.style.borderRadius = '4px';
                })
                .withFailureHandler(function(error) {
                    resultsDiv.innerHTML = `‚ùå Backend test failed: ${error.message}`;
                    resultsDiv.style.color = '#721c24';
                    resultsDiv.style.background = '#f8d7da';
                    resultsDiv.style.padding = '10px';
                    resultsDiv.style.borderRadius = '4px';
                })
                .testBackendConnection();
        }

        function testAuth() {
            const resultsDiv = document.getElementById('diagnosticResults');
            resultsDiv.innerHTML = '‚è≥ Testing Reddit OAuth...';

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        resultsDiv.innerHTML = `‚úÖ ${result.message}<br>Token length: ${result.tokenLength} characters`;
                        resultsDiv.style.color = '#155724';
                        resultsDiv.style.background = '#d4edda';
                        resultsDiv.style.padding = '10px';
                        resultsDiv.style.borderRadius = '4px';
                    } else {
                        resultsDiv.innerHTML = `‚ùå OAuth failed: ${result.message}<br>Error: ${result.error}`;
                        resultsDiv.style.color = '#721c24';
                        resultsDiv.style.background = '#f8d7da';
                        resultsDiv.style.padding = '10px';
                        resultsDiv.style.borderRadius = '4px';
                    }
                })
                .withFailureHandler(function(error) {
                    resultsDiv.innerHTML = `‚ùå OAuth test failed: ${error.message}`;
                    resultsDiv.style.color = '#721c24';
                    resultsDiv.style.background = '#f8d7da';
                    resultsDiv.style.padding = '10px';
                    resultsDiv.style.borderRadius = '4px';
                })
                .testRedditAuth();
        }

        // ========================================================================
        // TAB SWITCHING
        // ========================================================================

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide tabs
            document.getElementById('topicTab').style.display = tab === 'topic' ? 'block' : 'none';
            document.getElementById('subredditTab').style.display = tab === 'subreddit' ? 'block' : 'none';
            document.getElementById('urlTab').style.display = tab === 'url' ? 'block' : 'none';

            // Hide search results when switching
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('subredditResults').style.display = 'none';
        }

        function toggleSubredditInput() {
            const checkbox = document.getElementById('subredditFilter');
            const div = document.getElementById('subredditInputDiv');
            div.style.display = checkbox.checked ? 'block' : 'none';
        }

        // ========================================================================
        // TOPIC SEARCH
        // ========================================================================

        function searchByTopic() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                alert('Please enter a topic to search');
                return;
            }

            const timeRange = document.getElementById('timeRange').value;
            const maxResults = parseInt(document.getElementById('maxResults').value);
            const subredditFilter = document.getElementById('subredditFilter').checked
                ? document.getElementById('subredditInput').value.trim()
                : '';

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Searching Reddit for high-engagement posts...';

            // Call backend search function
            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('loading').style.display = 'none';

                    if (result.success) {
                        searchResults = result.posts;
                        selectedPosts.clear();
                        displaySearchResults(result);
                    } else {
                        alert('Search failed: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('Search error: ' + error.message);
                })
                .searchRedditByTopic(topic, timeRange, subredditFilter, maxResults);
        }

        function displaySearchResults(result) {
            const searchResultsDiv = document.getElementById('searchResults');
            const postsListDiv = document.getElementById('postsList');
            const summaryDiv = document.getElementById('searchResultsSummary');

            // Show results section
            searchResultsDiv.style.display = 'block';

            // Update summary
            summaryDiv.innerHTML = `Found <strong>${result.afterFiltering}</strong> high-engagement posts ${result.totalFound > result.afterFiltering ? `(filtered from ${result.totalFound} total)` : ''}`;

            // Generate post cards
            postsListDiv.innerHTML = result.posts.map(post => {
                const stars = '‚≠ê'.repeat(post.engagementStars);
                const upvotePercent = Math.round(post.upvote_ratio * 100);

                return `
                    <div class="post-card" onclick="togglePostSelection('${post.id}')" id="post-${post.id}">
                        <div style="display: flex; align-items: flex-start;">
                            <input type="checkbox" class="post-checkbox" id="check-${post.id}" onclick="event.stopPropagation(); togglePostSelection('${post.id}')">
                            <div style="flex: 1;">
                                <div class="post-title">${escapeHtml(post.title)}</div>
                                <div class="post-meta">
                                    <div class="post-meta-item">
                                        <strong>r/${escapeHtml(post.subreddit)}</strong>
                                    </div>
                                    <div class="post-meta-item">
                                        ‚¨ÜÔ∏è ${post.score.toLocaleString()}
                                    </div>
                                    <div class="post-meta-item">
                                        üí¨ ${post.num_comments.toLocaleString()}
                                    </div>
                                    <div class="post-meta-item">
                                        üìä ${upvotePercent}% upvoted
                                    </div>
                                    <div class="post-meta-item">
                                        üïê ${post.ageText}
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                                    <span class="engagement-stars" title="Engagement: ${post.engagementTier}">${stars}</span>
                                    <span style="font-size: 0.85em; color: #718096;">
                                        Engagement Score: ${post.engagementScore.toLocaleString()}
                                        ${post.engagementRate > 0 ? `(${post.engagementRate}/10k subscribers)` : ''}
                                    </span>
                                </div>
                                ${post.selftext ? `
                                    <div class="post-preview">
                                        ${escapeHtml(post.selftext)}${post.selftext.length >= 200 ? '...' : ''}
                                    </div>
                                ` : ''}
                                <div class="post-actions" onclick="event.stopPropagation();">
                                    <a href="${post.url}" target="_blank" class="post-link">üîó View on Reddit</a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Hide action buttons initially
            document.getElementById('selectedPostsActions').style.display = 'none';

            // Scroll to results
            searchResultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function togglePostSelection(postId) {
            const card = document.getElementById('post-' + postId);
            const checkbox = document.getElementById('check-' + postId);

            if (selectedPosts.has(postId)) {
                selectedPosts.delete(postId);
                card.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedPosts.add(postId);
                card.classList.add('selected');
                checkbox.checked = true;
            }

            updateSelectedCount();
        }

        function updateSelectedCount() {
            const count = selectedPosts.size;
            document.getElementById('selectedCount').textContent = `${count} post${count !== 1 ? 's' : ''} selected`;
            document.getElementById('selectedPostsActions').style.display = count > 0 ? 'block' : 'none';
        }

        function extractSelectedPosts() {
            if (selectedPosts.size === 0) {
                alert('Please select at least one post');
                return;
            }

            const mode = document.querySelector('input[name="analysisMode"]:checked').value;
            const selectedPostsData = searchResults.filter(post => selectedPosts.has(post.id));

            if (mode === 'separate') {
                // Analyze each post separately
                startMultiPostExtraction(selectedPostsData);
            } else {
                // Combine all posts
                alert('Combine mode coming soon!\n\nFor now, analyzing posts separately.');
                startMultiPostExtraction(selectedPostsData);
            }
        }

        // ========================================================================
        // SUBREDDIT ANALYSIS
        // ========================================================================

        let subredditSearchResults = [];
        let subredditSelectedPosts = new Set();

        function searchSubreddit() {
            const subreddit = document.getElementById('subredditName').value.trim();
            if (!subreddit) {
                alert('Please enter a subreddit name');
                return;
            }

            const timeRange = document.getElementById('subredditTimeRange').value;
            const maxResults = parseInt(document.getElementById('subredditMaxResults').value);

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = `Searching r/${subreddit} for top posts...`;

            // Call backend search function
            google.script.run
                .withSuccessHandler(function(result) {
                    document.getElementById('loading').style.display = 'none';

                    if (result.success) {
                        subredditSearchResults = result.posts;
                        subredditSelectedPosts.clear();
                        displaySubredditResults(result);
                    } else {
                        alert('Search failed: ' + result.message);
                    }
                })
                .withFailureHandler(function(error) {
                    document.getElementById('loading').style.display = 'none';
                    alert('Search error: ' + error.message);
                })
                .searchSubredditTopPosts(subreddit, timeRange, maxResults);
        }

        function displaySubredditResults(result) {
            const searchResultsDiv = document.getElementById('subredditResults');
            const postsListDiv = document.getElementById('subredditPostsList');
            const summaryDiv = document.getElementById('subredditResultsSummary');

            // Show results section
            searchResultsDiv.style.display = 'block';

            // Update summary
            summaryDiv.innerHTML = `Found <strong>${result.afterFiltering}</strong> high-engagement posts ${result.totalFound > result.afterFiltering ? `(filtered from ${result.totalFound} total)` : ''} from <strong>r/${result.subreddit}</strong>`;

            // Generate post cards
            postsListDiv.innerHTML = result.posts.map(post => {
                const stars = '‚≠ê'.repeat(post.engagementStars);
                const upvotePercent = Math.round(post.upvote_ratio * 100);

                return `
                    <div class="post-card" onclick="toggleSubredditPostSelection('${post.id}')" id="subreddit-post-${post.id}">
                        <div style="display: flex; align-items: flex-start;">
                            <input type="checkbox" class="post-checkbox" id="subreddit-check-${post.id}" onclick="event.stopPropagation(); toggleSubredditPostSelection('${post.id}')">
                            <div style="flex: 1;">
                                <div class="post-title">${escapeHtml(post.title)}</div>
                                <div class="post-meta">
                                    <strong>r/${escapeHtml(post.subreddit)}</strong>
                                    ‚Ä¢ ‚¨ÜÔ∏è ${post.score.toLocaleString()}
                                    ‚Ä¢ üí¨ ${post.num_comments.toLocaleString()}
                                    ‚Ä¢ üìä ${upvotePercent}% upvoted
                                    ‚Ä¢ üïê ${post.ageText}
                                </div>
                                <div style="margin-top: 8px;">
                                    <span class="engagement-stars">${stars}</span>
                                    <span style="color: #667eea; font-weight: 500; margin-left: 10px;">
                                        Engagement Score: ${post.engagementScore.toLocaleString()}
                                        (${post.engagementRate}/10k subscribers)
                                    </span>
                                </div>
                                ${post.selftext ? `<div class="post-preview">${escapeHtml(post.selftext)}</div>` : ''}
                                <a href="${post.url}" target="_blank" onclick="event.stopPropagation()" style="color: #667eea; text-decoration: none; font-size: 0.9em; margin-top: 8px; display: inline-block;">
                                    üîó View on Reddit
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleSubredditPostSelection(postId) {
            if (subredditSelectedPosts.has(postId)) {
                subredditSelectedPosts.delete(postId);
                document.getElementById(`subreddit-post-${postId}`).classList.remove('selected');
                document.getElementById(`subreddit-check-${postId}`).checked = false;
            } else {
                subredditSelectedPosts.add(postId);
                document.getElementById(`subreddit-post-${postId}`).classList.add('selected');
                document.getElementById(`subreddit-check-${postId}`).checked = true;
            }
            updateSubredditSelectedCount();
        }

        function updateSubredditSelectedCount() {
            const count = subredditSelectedPosts.size;
            document.getElementById('subredditSelectedCount').textContent = `${count} post${count !== 1 ? 's' : ''} selected`;

            // Show/hide actions
            const actionsDiv = document.getElementById('subredditSelectedPostsActions');
            actionsDiv.style.display = count > 0 ? 'block' : 'none';
        }

        function extractSubredditSelectedPosts() {
            if (subredditSelectedPosts.size === 0) {
                alert('Please select at least one post');
                return;
            }

            const mode = document.querySelector('input[name="subredditAnalysisMode"]:checked').value;
            const selectedPostsData = subredditSearchResults.filter(post => subredditSelectedPosts.has(post.id));

            if (mode === 'separate') {
                // Analyze each post separately
                startMultiPostExtraction(selectedPostsData);
            } else {
                // Combine all posts
                alert('Combine mode coming soon!\n\nFor now, analyzing posts separately.');
                startMultiPostExtraction(selectedPostsData);
            }
        }

        // ========================================================================
        // MULTI-POST EXTRACTION
        // ========================================================================

        let postsQueue = [];
        let currentPostIndex = 0;
        let multiPostResults = [];

        function startMultiPostExtraction(posts) {
            console.log('Starting multi-post extraction for', posts.length, 'posts');
            postsQueue = posts;
            currentPostIndex = 0;
            multiPostResults = [];

            // Hide tabs
            document.getElementById('topicTab').style.display = 'none';
            document.getElementById('subredditTab').style.display = 'none';
            document.getElementById('urlTab').style.display = 'none';
            document.getElementById('step1Container').style.display = 'none';
            document.getElementById('step2Container').style.display = 'none';
            document.getElementById('insightsContainer').style.display = 'none';

            // Show multi-post container
            const multiPostContainer = document.getElementById('multiPostContainer');
            multiPostContainer.style.display = 'block';

            // Update title and reset results
            document.getElementById('multiPostTitle').textContent = `üìä Extracting ${posts.length} Posts`;
            document.getElementById('progressText').textContent = 'Starting...';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('multiPostResults').innerHTML = '';
            document.getElementById('multiPostActions').style.display = 'none';

            console.log('Multi-post container shown, starting extraction...');

            // Start processing first post
            processNextPost();
        }

        function processNextPost() {
            if (currentPostIndex >= postsQueue.length) {
                // All posts processed
                document.getElementById('progressText').textContent = `‚úÖ Completed ${postsQueue.length} posts!`;
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('multiPostActions').style.display = 'block';
                return;
            }

            const post = postsQueue[currentPostIndex];
            const progressPercent = (currentPostIndex / postsQueue.length) * 100;

            document.getElementById('progressText').textContent = `Extracting post ${currentPostIndex + 1} of ${postsQueue.length}...`;
            document.getElementById('progressBar').style.width = progressPercent + '%';

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = `Extracting post ${currentPostIndex + 1} of ${postsQueue.length}: ${post.title.substring(0, 50)}...`;

            // Extract this post
            const callbackName = 'multiPostCallback_' + Date.now();
            window[callbackName] = function(response) {
                console.log('Multi-post callback received for post', currentPostIndex + 1, response);
                document.getElementById('loading').style.display = 'none';

                if (response.success) {
                    console.log('Success! Data:', response.data);
                    multiPostResults.push({
                        post: post,
                        data: response.data
                    });
                    displayMultiPostResult(post, response.data, currentPostIndex);
                } else {
                    console.error('Error in response:', response.error);
                    displayMultiPostError(post, response.error || 'Unknown error', currentPostIndex);
                }

                // Move to next post
                currentPostIndex++;
                setTimeout(processNextPost, 500); // Small delay between posts

                // Clean up
                delete window[callbackName];
            };

            console.log('Fetching:', post.url, 'Callback:', callbackName);
            const script = document.createElement('script');
            script.src = `${SCRIPT_URL}?url=${encodeURIComponent(post.url)}&mode=step1_extract&callback=${callbackName}&t=${Date.now()}`;
            script.onerror = function() {
                console.error('Script load error for:', post.url);
                document.getElementById('loading').style.display = 'none';
                displayMultiPostError(post, 'Network error or timeout', currentPostIndex);
                currentPostIndex++;
                setTimeout(processNextPost, 500);
            };
            document.body.appendChild(script);
        }

        function displayMultiPostResult(post, data, index) {
            console.log('displayMultiPostResult called for index:', index, 'post:', post.title);
            const resultsContainer = document.getElementById('multiPostResults');

            if (!resultsContainer) {
                console.error('multiPostResults container not found!');
                return;
            }

            // Clear the placeholder text on first post
            if (index === 0) {
                resultsContainer.innerHTML = '';
            }

            const stats = data.extractionStats || {};
            console.log('Stats for post', index, ':', stats);

            // Map backend field names to display values
            const totalComments = stats.total || stats.totalComments || 0;
            const valuableComments = stats.extracted || stats.valuableComments || 0;
            const totalUpvotes = stats.averageScore || stats.totalUpvotes || 0;

            // Calculate avg word count from comments
            let avgWordCount = 0;
            if (data.valuableComments && data.valuableComments.length > 0) {
                const totalWords = data.valuableComments.reduce((sum, comment) => {
                    const words = comment.body ? comment.body.split(/\s+/).length : 0;
                    return sum + words;
                }, 0);
                avgWordCount = Math.round(totalWords / data.valuableComments.length);
            }

            // Create simple card with ONLY inline styles
            const card = document.createElement('div');
            card.style.cssText = 'background: white; border: 3px solid #667eea; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);';

            card.innerHTML = `
                <h3 style="color: #667eea; font-size: 1.5em; margin: 0 0 15px 0;">
                    ${index + 1}. ${escapeHtml(post.title)}
                </h3>

                <div style="margin-bottom: 20px;">
                    <span style="background: #eef2ff; padding: 8px 12px; border-radius: 4px; margin-right: 10px; display: inline-block;">
                        <strong>r/${escapeHtml(post.subreddit)}</strong>
                    </span>
                    <span style="background: #f0fdf4; padding: 8px 12px; border-radius: 4px; margin-right: 10px; display: inline-block;">
                        ‚¨ÜÔ∏è ${post.score.toLocaleString()}
                    </span>
                    <span style="background: #fef3c7; padding: 8px 12px; border-radius: 4px; display: inline-block;">
                        üí¨ ${post.num_comments.toLocaleString()}
                    </span>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #667eea;">${totalComments}</div>
                        <div style="color: #718096; font-size: 0.9em;">Total Comments</div>
                    </div>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #48bb78;">${valuableComments}</div>
                        <div style="color: #718096; font-size: 0.9em;">Valuable Comments</div>
                    </div>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #f59e0b;">${totalUpvotes}</div>
                        <div style="color: #718096; font-size: 0.9em;">Avg Upvotes</div>
                    </div>
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #9f7aea;">${avgWordCount}</div>
                        <div style="color: #718096; font-size: 0.9em;">Avg Word Count</div>
                    </div>
                </div>

                <div style="margin-top: 25px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <button onclick="generatePostInsights(${index})" id="insightsBtn_${index}" style="background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600; width: 100%;">
                            üí° Generate Insights (Step 3 Analysis)
                        </button>
                    </div>

                    <div id="insightsSection_${index}" style="display: none; margin-top: 20px; padding: 20px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #667eea;">
                        <div id="insightsContent_${index}"></div>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                        <button onclick="downloadSinglePostPDF(${index})" style="background: #ed8936; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                            üìÑ Export PDF
                        </button>
                        <button onclick="downloadSinglePostForClaude(${index})" style="background: #48bb78; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                            üíæ Download for Claude
                        </button>
                        <button onclick="copySinglePostForClaude(${index})" style="background: #9f7aea; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                            üìã Copy
                        </button>
                    </div>
                </div>
            `;

            resultsContainer.appendChild(card);
            console.log('Simple card added to DOM for index:', index);
        }

        function displayMultiPostError(post, error, index) {
            const resultsContainer = document.getElementById('multiPostResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'step-container';
            resultDiv.style.marginBottom = '20px';
            resultDiv.style.borderColor = '#f56565';

            resultDiv.innerHTML = `
                <div class="step-header">
                    <div class="step-number" style="background: #f56565;">${index + 1}</div>
                    <div class="step-title">‚ùå Failed: ${escapeHtml(post.title)}</div>
                </div>
                <div style="color: #c53030; padding: 15px; background: #fff5f5; border-radius: 8px;">
                    <strong>Error:</strong> ${escapeHtml(error)}
                </div>
            `;

            resultsContainer.appendChild(resultDiv);
        }

        function collapseMultiPost(index) {
            const container = document.getElementById(`multiPost_${index}`);
            if (container) {
                const statsGrid = container.querySelector('.stats-grid');
                const actionButtons = container.querySelector('.action-buttons');
                const isCollapsed = statsGrid.style.display === 'none';

                statsGrid.style.display = isCollapsed ? 'grid' : 'none';
                actionButtons.style.display = isCollapsed ? 'flex' : 'none';

                const collapseBtn = container.querySelector('.collapse-btn');
                collapseBtn.textContent = isCollapsed ? 'Collapse' : 'Expand';
            }
        }

        function downloadSinglePostPDF(index) {
            if (multiPostResults[index]) {
                const oldData = extractedData;
                extractedData = multiPostResults[index].data;
                exportToPDF();
                extractedData = oldData;
            }
        }

        function downloadSinglePostForClaude(index) {
            if (multiPostResults[index]) {
                const result = multiPostResults[index];
                const formattedText = formatForClaudeAnalysis(result.data);
                const fileName = `reddit_analysis_${result.post.subreddit}_${Date.now()}.txt`;

                const blob = new Blob([formattedText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function copySinglePostForClaude(index) {
            if (multiPostResults[index]) {
                const result = multiPostResults[index];
                const formattedText = formatForClaudeAnalysis(result.data);

                navigator.clipboard.writeText(formattedText).then(() => {
                    alert('‚úÖ Content copied to clipboard! Paste it into Claude for analysis.');
                }).catch(err => {
                    alert('Failed to copy: ' + err);
                });
            }
        }

        function backToSearch() {
            // Hide multi-post container
            document.getElementById('multiPostContainer').style.display = 'none';

            // Show the appropriate tab
            document.getElementById('subredditTab').style.display = 'block';

            // Reset multi-post state
            postsQueue = [];
            currentPostIndex = 0;
            multiPostResults = [];
        }

        // ========================================================================
        // MULTI-POST INSIGHTS GENERATION
        // ========================================================================

        function generatePostInsights(index) {
            const btn = document.getElementById(`insightsBtn_${index}`);
            const section = document.getElementById(`insightsSection_${index}`);
            const contentDiv = document.getElementById(`insightsContent_${index}`);

            // Toggle visibility
            if (section.style.display === 'block') {
                section.style.display = 'none';
                btn.textContent = 'üí° Generate Insights (Step 3 Analysis)';
                return;
            }

            // Show section
            section.style.display = 'block';
            btn.textContent = 'üîº Hide Insights';

            // Check if already generated
            if (contentDiv.innerHTML !== '') {
                return;
            }

            // Show loading
            contentDiv.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="color: #667eea; font-weight: 500;">üîÑ Analyzing comments...</div>
                </div>
            `;

            // Get the post data
            const result = multiPostResults[index];
            if (!result) {
                contentDiv.innerHTML = '<div style="color: #c53030;">Error: No data found for this post</div>';
                return;
            }

            // Generate insights using all available analysis types
            setTimeout(() => {
                const allAnalysisTypes = [
                    'entity_analysis',
                    'outcome_analysis',
                    'speaker_analysis',
                    'pricing_analysis',
                    'timeline_analysis',
                    'consensus_analysis',
                    'qa_analysis',
                    'evidence_analysis'
                ];

                const insights = generateInsightsInBrowser(result.data, allAnalysisTypes);

                // Display insights
                let html = '<h4 style="color: #667eea; margin: 0 0 15px 0;">üí° Key Insights</h4>';

                if (insights.length === 0) {
                    html += '<p style="color: #718096;">No significant insights found for this post.</p>';
                } else {
                    insights.forEach(insight => {
                        html += `
                            <div style="background: white; padding: 12px 15px; margin-bottom: 10px;
                                border-radius: 6px; border-left: 4px solid #667eea;">
                                <div style="font-size: 0.85em; color: #9f7aea; font-weight: 600;
                                    text-transform: uppercase; margin-bottom: 5px;">
                                    ${escapeHtml(insight.type.replace(/_/g, ' '))}
                                </div>
                                <div style="color: #2d3748;">üí° ${escapeHtml(insight.insight)}</div>
                            </div>
                        `;
                    });
                }

                // Add PDF download button
                html += `
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="downloadPostInsightsPDF(${index})"
                            style="background: #667eea; color: white; border: none; padding: 12px 24px;
                            border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600;">
                            üìÑ Download Insights as PDF
                        </button>
                    </div>
                `;

                contentDiv.innerHTML = html;
            }, 100);
        }

        function downloadPostInsightsPDF(index) {
            const result = multiPostResults[index];
            if (!result) {
                alert('No data found for this post');
                return;
            }

            // Generate insights
            const allAnalysisTypes = [
                'entity_analysis',
                'outcome_analysis',
                'speaker_analysis',
                'pricing_analysis',
                'timeline_analysis',
                'consensus_analysis',
                'qa_analysis',
                'evidence_analysis'
            ];

            const insights = generateInsightsInBrowser(result.data, allAnalysisTypes);
            const post = result.post;
            const data = result.data;
            const stats = data.extractionStats || {};

            // Create PDF window
            const printWindow = window.open('', '', 'width=800,height=600');

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Insights - ${escapeHtml(post.title)}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        h1 {
                            color: #667eea;
                            font-size: 1.5em;
                            margin-bottom: 10px;
                        }
                        h2 {
                            color: #4a5568;
                            font-size: 1.2em;
                            margin: 10px 0;
                        }
                        .meta {
                            color: #666;
                            font-size: 0.9em;
                            margin-bottom: 15px;
                        }
                        .stats {
                            background: #f5f5f5;
                            padding: 15px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                        }
                        h3 {
                            color: #667eea;
                            margin-bottom: 15px;
                        }
                        .insight {
                            border-left: 4px solid #667eea;
                            padding: 12px 15px;
                            margin-bottom: 15px;
                            background: #f9f9f9;
                            page-break-inside: avoid;
                        }
                        .insight-type {
                            font-size: 0.85em;
                            color: #9f7aea;
                            font-weight: 600;
                            text-transform: uppercase;
                            margin-bottom: 5px;
                        }
                        .insight-text {
                            color: #2d3748;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            color: #999;
                            font-size: 0.85em;
                        }
                        @media print {
                            body { margin: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üí° Reddit Post Insights</h1>
                        <h2>${escapeHtml(post.title)}</h2>
                        <div class="meta">
                            r/${escapeHtml(post.subreddit)} ‚Ä¢ Posted by u/${escapeHtml(post.author)} ‚Ä¢
                            ${post.score.toLocaleString()} upvotes ‚Ä¢ ${post.num_comments.toLocaleString()} comments
                        </div>
                    </div>

                    <div class="stats">
                        <strong>Analysis Summary:</strong><br>
                        Total Comments: ${stats.total || 0} |
                        Valuable Comments Analyzed: ${stats.extracted || 0} |
                        Insights Generated: ${insights.length}
                    </div>

                    <h3>Key Insights</h3>
                    ${insights.map(insight => `
                        <div class="insight">
                            <div class="insight-type">${escapeHtml(insight.type.replace(/_/g, ' '))}</div>
                            <div class="insight-text">üí° ${escapeHtml(insight.insight)}</div>
                        </div>
                    `).join('')}

                    ${insights.length === 0 ? '<p style="color: #718096; text-align: center; padding: 20px;">No significant insights found for this post.</p>' : ''}

                    <div class="footer">
                        Generated by Reddit Analyzer ‚Ä¢ ${new Date().toLocaleString()}
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();

            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // ========================================================================
        // ANALYSIS FUNCTIONS
        // ========================================================================

        let analysisCache = {}; // Store generated analyses

        function toggleAnalysis(index) {
            const section = document.getElementById(`analysisSection_${index}`);
            const btnText = document.getElementById(`analysisBtn_${index}`);

            if (section.style.display === 'none') {
                // Show analysis section
                section.style.display = 'block';
                btnText.textContent = 'Hide Analysis';

                // If not already generated, generate it now
                if (!analysisCache[index]) {
                    generateAnalysis(index);
                }
            } else {
                // Hide analysis section
                section.style.display = 'none';
                btnText.textContent = 'Show Analysis';
            }
        }

        function generateAnalysis(index) {
            const contentDiv = document.getElementById(`analysisContent_${index}`);
            const result = multiPostResults[index];

            if (!result) {
                contentDiv.innerHTML = '<div style="color: #c53030;">Error: No data found for this post</div>';
                return;
            }

            // Show loading
            contentDiv.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner" style="margin: 0 auto 20px;"></div>
                    <div style="color: #667eea; font-weight: 500;">Generating analysis...</div>
                    <div style="color: #718096; font-size: 0.9em; margin-top: 10px;">This may take a few moments</div>
                </div>
            `;

            // For now, use the existing regex-based analysis
            // In the future, this will call AI API
            setTimeout(() => {
                const data = result.data;
                const comments = data.valuableComments || [];

                // Generate insights using existing functions
                const insights = generateDataTables(data);

                // Build HTML
                let analysisHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">üí° Analysis Results</h3>
                        <p style="color: #718096; margin-bottom: 20px;">
                            Based on ${comments.length} valuable comments from this discussion
                        </p>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #4a5568; margin-bottom: 10px; font-size: 1.1em;">üìä Data Tables</h4>
                        ${insights.length > 0 ? insights.join('') : '<p style="color: #718096;">No data tables available for this content type.</p>'}
                    </div>

                    <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
                        <button class="btn" onclick="exportAnalysisPDF(${index})" style="background: #ed8936; margin-right: 10px;">
                            üìÑ Export Analysis as PDF
                        </button>
                        <button class="btn" onclick="downloadAnalysisForClaude(${index})" style="background: #48bb78; margin-right: 10px;">
                            üíæ Download Analysis for Claude
                        </button>
                        <button class="btn" onclick="copyAnalysisForClaude(${index})" style="background: #9f7aea;">
                            üìã Copy Analysis to Clipboard
                        </button>
                    </div>
                `;

                contentDiv.innerHTML = analysisHTML;
                analysisCache[index] = analysisHTML;
            }, 1000); // Simulate processing time
        }

        function exportAnalysisPDF(index) {
            // Use the existing PDF export with analysis data
            if (multiPostResults[index]) {
                const oldData = extractedData;
                extractedData = multiPostResults[index].data;
                exportToPDF();
                extractedData = oldData;
            }
        }

        function downloadAnalysisForClaude(index) {
            if (multiPostResults[index]) {
                const result = multiPostResults[index];
                const formattedText = formatForClaudeAnalysis(result.data);
                const fileName = `reddit_analysis_${result.post.subreddit}_${Date.now()}.txt`;

                const blob = new Blob([formattedText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function copyAnalysisForClaude(index) {
            if (multiPostResults[index]) {
                const result = multiPostResults[index];
                const formattedText = formatForClaudeAnalysis(result.data);

                navigator.clipboard.writeText(formattedText).then(() => {
                    alert('‚úÖ Analysis copied to clipboard! Paste it into Claude for deeper insights.');
                }).catch(err => {
                    alert('Failed to copy: ' + err);
                });
            }
        }

        // ========================================================================
        // SINGLE URL ANALYSIS
        // ========================================================================

        function startAnalysis() {
            const url = document.getElementById('redditUrl').value.trim();
            if (!url) {
                alert('Please enter a Reddit URL');
                return;
            }

            // Reset
            document.getElementById('step1Container').style.display = 'none';
            document.getElementById('step2Container').style.display = 'none';
            document.getElementById('insightsContainer').style.display = 'none';
            extractedData = null;
            selectedAnalyses.clear();

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Extracting valuable content from comments...';

            // Call Step 1: Extract
            const callbackName = 'callback_' + Date.now();
            window[callbackName] = function(response) {
                document.getElementById('loading').style.display = 'none';

                if (response.success) {
                    extractedData = response.data;
                    displayStep1(response.data);
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }

                delete window[callbackName];
            };

            const scriptElement = document.createElement('script');
            scriptElement.src = `${SCRIPT_URL}?url=${encodeURIComponent(url)}&mode=step1_extract&callback=${callbackName}`;
            document.body.appendChild(scriptElement);
        }

        function displayStep1(data) {
            const container = document.getElementById('step1Container');
            container.style.display = 'block';

            // Display post title
            const postTitle = document.createElement('div');
            postTitle.style.cssText = 'background: #eef2ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;';
            postTitle.innerHTML = `
                <div style="font-size: 1.2em; font-weight: 600; color: #1a202c; margin-bottom: 10px;">
                    üìÑ ${escapeHtml(data.post.title)}
                </div>
                <div style="font-size: 0.9em; color: #718096;">
                    Posted by u/${escapeHtml(data.post.author)} ‚Ä¢ ${data.post.score} upvotes ‚Ä¢ ${data.post.num_comments} comments
                </div>
            `;
            document.getElementById('step1Container').insertBefore(postTitle, document.getElementById('extractionStats'));

            // Display stats
            const stats = data.extractionStats;
            document.getElementById('extractionStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Comments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.extracted}</div>
                    <div class="stat-label">High-Value Extracted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.percentageKept}%</div>
                    <div class="stat-label">Kept</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.averageScore}</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            `;

            // Display comments
            const commentList = document.getElementById('commentList');
            commentList.innerHTML = data.valuableComments.map(comment => `
                <div class="comment-card">
                    <div class="comment-meta">
                        <span class="comment-author">üë§ u/${escapeHtml(comment.author)}</span>
                        <span class="comment-score">‚¨ÜÔ∏è ${comment.score}</span>
                        ${comment.awards > 0 ? `<span>üèÜ ${comment.awards}</span>` : ''}
                    </div>
                    <div class="comment-body">${escapeHtml(comment.body.substring(0, 400))}${comment.body.length > 400 ? '...' : ''}</div>
                </div>
            `).join('');

            // Scroll to step 1
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function proceedToStep2() {
            if (!extractedData) return;

            // Run analysis in the browser - no backend call needed!
            const recommendations = analyzeAndRecommendInBrowser(extractedData);
            displayStep2(recommendations);
        }

        function analyzeAndRecommendInBrowser(contentData) {
            const comments = contentData.valuableComments || [];
            const recommendations = [];

            // 1. Entity & Topic Analysis
            const entities = {};
            comments.forEach(c => {
                const matches = (c.body || '').match(/\b[A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){0,3}\b/g) || [];
                matches.forEach(e => {
                    if (e.length > 3) entities[e] = (entities[e] || 0) + 1;
                });
            });
            const topEntities = Object.entries(entities).filter(([_, count]) => count >= 3).length;
            if (topEntities > 0) {
                recommendations.push({
                    id: 'entity_analysis',
                    name: 'Entity & Topic Analysis',
                    description: 'Identify most discussed industries, products, or topics with sentiment',
                    available: true,
                    dataFound: `${topEntities} entities mentioned 3+ times`,
                    estimatedInsights: Math.min(topEntities, 10)
                });
            }

            // 2. Success/Failure Rate Analysis
            const successCount = comments.filter(c => /\b(worked|success|helped|fixed|cured|solved|great|amazing)\b/i.test(c.body)).length;
            const failureCount = comments.filter(c => /\b(failed|didn't work|worse|useless|no help|terrible|awful)\b/i.test(c.body)).length;
            if (successCount + failureCount >= 10) {
                recommendations.push({
                    id: 'outcome_analysis',
                    name: 'Success/Failure Rate Analysis',
                    description: 'Calculate success rates and effectiveness',
                    available: true,
                    dataFound: `${successCount} success + ${failureCount} failure mentions`,
                    estimatedInsights: 3
                });
            }

            // 3. Expert vs Experience Mix
            const expertCount = comments.filter(c => /\b(I work|professional|doctor|engineer|specialist|expert)\b/i.test(c.body)).length;
            const experienceCount = comments.filter(c => /\b(I |my |me |I've|I'm|personally)\b/i.test(c.body)).length;
            if (expertCount >= 5 || experienceCount >= 20) {
                recommendations.push({
                    id: 'speaker_analysis',
                    name: 'Expert vs Personal Experience Mix',
                    description: 'Balance between professional advice and lived experiences',
                    available: true,
                    dataFound: `${expertCount} expert comments, ${experienceCount} personal experiences`,
                    estimatedInsights: 2
                });
            }

            // 4. Pricing/Cost Analysis
            const priceCount = comments.filter(c => /\$[\d,]+|\bcost\b|\bprice\b|\bexpensive\b|\bcheap\b|\baffordable\b/i.test(c.body)).length;
            if (priceCount >= 10) {
                recommendations.push({
                    id: 'pricing_analysis',
                    name: 'Pricing & Cost Analysis',
                    description: 'Price sensitivity and value perception',
                    available: true,
                    dataFound: `${priceCount} comments mention pricing/cost`,
                    estimatedInsights: 3
                });
            }

            // 5. Timeline Expectations
            const timeCount = comments.filter(c => /\b(immediate|instant|days?|weeks?|months?|years?|long.?term|short.?term)\b/i.test(c.body)).length;
            if (timeCount >= 10) {
                recommendations.push({
                    id: 'timeline_analysis',
                    name: 'Timeline Expectations',
                    description: 'How long things take based on community experiences',
                    available: true,
                    dataFound: `${timeCount} comments mention timeframes`,
                    estimatedInsights: 2
                });
            }

            // 6. Consensus vs Controversy
            const agreeCount = comments.filter(c => /\b(agree|exactly|this|same|correct|absolutely)\b/i.test(c.body)).length;
            const disagreeCount = comments.filter(c => /\b(disagree|wrong|false|actually|but |however)\b/i.test(c.body)).length;
            if (agreeCount + disagreeCount >= 15) {
                const controversyRatio = disagreeCount / (agreeCount + disagreeCount);
                recommendations.push({
                    id: 'consensus_analysis',
                    name: controversyRatio > 0.4 ? 'Controversy Analysis' : 'Consensus Patterns',
                    description: controversyRatio > 0.4 ? 'Divisive topic with conflicting viewpoints' : 'Community alignment and agreement patterns',
                    available: true,
                    dataFound: `${Math.round(controversyRatio * 100)}% disagreement rate`,
                    estimatedInsights: 3
                });
            }

            // 7. Question/Answer Patterns
            const questionCount = comments.filter(c => /\?/.test(c.body)).length;
            const answerIndicators = comments.filter(c => /\b(here's|this is|you should|try|check out|look at)\b/i.test(c.body)).length;
            if (questionCount >= 5 && answerIndicators >= 5) {
                recommendations.push({
                    id: 'qa_analysis',
                    name: 'Question/Answer Dynamics',
                    description: 'Problem-solving and knowledge-sharing patterns',
                    available: true,
                    dataFound: `${questionCount} questions, ${answerIndicators} solution-oriented responses`,
                    estimatedInsights: 2
                });
            }

            // 8. Evidence & Source Quality
            const sourcedCount = comments.filter(c => /\b(source|study|research|according to|data shows)\b/i.test(c.body) || /https?:\/\//.test(c.body)).length;
            const anecdotalCount = comments.filter(c => /\b(in my experience|I think|I feel|personally|IMO|IMHO)\b/i.test(c.body)).length;
            if (sourcedCount + anecdotalCount >= 15) {
                const evidenceRatio = sourcedCount / (sourcedCount + anecdotalCount);
                recommendations.push({
                    id: 'evidence_analysis',
                    name: 'Evidence Quality Analysis',
                    description: 'Evidence-based vs opinion-based discussion balance',
                    available: true,
                    dataFound: `${Math.round(evidenceRatio * 100)}% sourced/evidence-based`,
                    estimatedInsights: 2
                });
            }

            // 9. Comparison Patterns (X vs Y)
            const comparisonCount = comments.filter(c => /\b(vs|versus|compared to|better than|worse than|instead of)\b/i.test(c.body)).length;
            if (comparisonCount >= 8) {
                recommendations.push({
                    id: 'comparison_analysis',
                    name: 'Comparison & Decision Analysis',
                    description: 'What people compare and evaluation criteria',
                    available: true,
                    dataFound: `${comparisonCount} comparison statements`,
                    estimatedInsights: 3
                });
            }

            // 10. Emotional Tone
            const positiveCount = comments.filter(c => /\b(love|excited|happy|grateful|amazing|fantastic|incredible)\b/i.test(c.body)).length;
            const negativeCount = comments.filter(c => /\b(hate|angry|frustrated|disappointed|terrible|awful|horrible)\b/i.test(c.body)).length;
            const neutralCount = comments.length - positiveCount - negativeCount;
            if (positiveCount + negativeCount >= 15) {
                const sentiment = positiveCount > negativeCount * 1.5 ? 'Positive' : negativeCount > positiveCount * 1.5 ? 'Negative' : 'Mixed';
                recommendations.push({
                    id: 'emotion_analysis',
                    name: `Emotional Tone: ${sentiment}`,
                    description: 'Community emotional response and sentiment',
                    available: true,
                    dataFound: `${positiveCount} positive, ${negativeCount} negative, ${neutralCount} neutral`,
                    estimatedInsights: 2
                });
            }

            return {
                totalRecommendations: recommendations.length,
                availableAnalyses: recommendations.length,
                recommendations: recommendations
            };
        }

        function displayStep2(data) {
            const container = document.getElementById('step2Container');
            container.style.display = 'block';

            const grid = document.getElementById('recommendationsGrid');
            grid.innerHTML = data.recommendations.map(rec => `
                <div class="recommendation-card ${rec.available ? '' : 'unavailable'}"
                     onclick="${rec.available ? `toggleAnalysis('${rec.id}')` : ''}"
                     id="rec_${rec.id}">
                    <div class="recommendation-header">
                        ${rec.available ? `<input type="checkbox" class="checkbox" id="check_${rec.id}" onchange="updateSelection()">` : ''}
                        <div class="recommendation-title">${rec.available ? '‚úì' : '‚úó'} ${escapeHtml(rec.name)}</div>
                    </div>
                    <div class="recommendation-desc">${escapeHtml(rec.description)}</div>
                    <div class="recommendation-data">üìä ${escapeHtml(rec.dataFound)}</div>
                    ${rec.available ? `<div class="recommendation-estimate">~${rec.estimatedInsights} insights expected</div>` : ''}
                </div>
            `).join('');

            // Scroll to step 2
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function toggleAnalysis(analysisId) {
            const checkbox = document.getElementById('check_' + analysisId);
            const card = document.getElementById('rec_' + analysisId);

            if (checkbox.checked) {
                selectedAnalyses.delete(analysisId);
                checkbox.checked = false;
                card.classList.remove('selected');
            } else {
                selectedAnalyses.add(analysisId);
                checkbox.checked = true;
                card.classList.add('selected');
            }

            updateSelection();
        }

        function updateSelection() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = selectedAnalyses.size === 0;
            btn.textContent = `Step 3: Generate ${selectedAnalyses.size} Selected Insight${selectedAnalyses.size !== 1 ? 's' : ''} ‚Üí`;
        }

        function proceedToStep3() {
            if (selectedAnalyses.size === 0 || !extractedData) {
                alert('Please select at least one analysis type');
                return;
            }

            // Get the Reddit URL from input field
            const url = document.getElementById('redditUrl').value.trim();
            if (!url) {
                alert('Reddit URL not found. Please start over.');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'ü§ñ Analyzing with Gemini AI... This may take 10-30 seconds...';

            // Call backend for AI-powered analysis
            const callbackName = 'callback_step3_' + Date.now();
            window[callbackName] = function(response) {
                document.getElementById('loading').style.display = 'none';

                if (response.success) {
                    displayStep3(response.data);
                } else {
                    alert('AI Analysis failed: ' + (response.error || response.message || 'Unknown error'));
                }

                delete window[callbackName];
            };

            const scriptElement = document.createElement('script');
            scriptElement.src = `${SCRIPT_URL}?url=${encodeURIComponent(url)}&mode=step3_analyze&selectedAnalyses=${encodeURIComponent(JSON.stringify(Array.from(selectedAnalyses)))}&callback=${callbackName}`;
            document.body.appendChild(scriptElement);
        }

        function generateInsightsInBrowser(contentData, selectedAnalyses) {
            const comments = contentData.valuableComments || [];
            const insights = [];

            // Stopwords for entity extraction
            const stopwords = new Set(['The', 'This', 'That', 'These', 'Those', 'They', 'There', 'What', 'When', 'Where', 'Every', 'Each', 'Some', 'Many', 'More', 'Most', 'From', 'With', 'Reddit', 'Edit', 'Update', 'People', 'Data']);

            selectedAnalyses.forEach(analysisId => {
                if (analysisId === 'entity_analysis') {
                    // Entity & Topic Analysis
                    const entities = {};
                    const basePosWords = ['good', 'great', 'love', 'best', 'worked', 'helped', 'success', 'amazing', 'booming', 'growing'];
                    const baseNegWords = ['bad', 'terrible', 'hate', 'worst', 'failed', 'useless', 'awful', 'dying', 'declining'];

                    comments.forEach(c => {
                        const body = c.body || '';
                        const matches = body.match(/\b[A-Z][A-Za-z]+(?:\s+[A-Z][A-Za-z]+){0,3}\b/g) || [];
                        matches.forEach(entity => {
                            if (entity.length > 3 && !stopwords.has(entity)) {
                                if (!entities[entity]) entities[entity] = {count: 0, pos: 0, neg: 0, neu: 0};
                                entities[entity].count++;

                                const idx = body.indexOf(entity);
                                const context = body.substring(Math.max(0, idx - 60), Math.min(body.length, idx + entity.length + 60)).toLowerCase();
                                if (basePosWords.some(w => context.includes(w))) entities[entity].pos++;
                                else if (baseNegWords.some(w => context.includes(w))) entities[entity].neg++;
                                else entities[entity].neu++;
                            }
                        });
                    });

                    const topEntities = Object.entries(entities)
                        .filter(([_, data]) => data.count >= 3)
                        .sort((a, b) => b[1].count - a[1].count)
                        .slice(0, 10);

                    topEntities.forEach(([entity, data]) => {
                        const total = data.pos + data.neg + data.neu;
                        const sentiment = total > 0 ? Math.round((data.pos / total) * 100) : 0;
                        const percentage = Math.round((data.count / comments.length) * 100);

                        let sentimentText = '';
                        if (sentiment >= 70) sentimentText = ` with ${sentiment}% positive sentiment - highly favored`;
                        else if (sentiment <= 30 && sentiment > 0) sentimentText = ` with only ${sentiment}% positive sentiment - concerns noted`;

                        insights.push({
                            type: 'entity_analysis',
                            insight: `"${entity}" discussed in ${percentage}% of comments (${data.count} mentions)${sentimentText}`
                        });
                    });
                }

                if (analysisId === 'outcome_analysis') {
                    const worked = comments.filter(c => /\b(worked|success|helped|fixed|cured|solved)\b/i.test(c.body)).length;
                    const failed = comments.filter(c => /\b(failed|didn't work|worse|useless|no help)\b/i.test(c.body)).length;
                    const total = worked + failed;

                    if (total >= 10) {
                        const successRate = Math.round((worked / total) * 100);
                        let interpretation = successRate >= 70 ? 'highly effective' : successRate >= 50 ? 'moderately effective' : successRate >= 30 ? 'mixed results' : 'low success rate';

                        insights.push({
                            type: 'outcome_analysis',
                            insight: `${successRate}% success rate across reported attempts (${worked} worked vs ${failed} failed) - ${interpretation}`
                        });
                    }
                }

                if (analysisId === 'speaker_analysis') {
                    const expertCount = comments.filter(c => /\b(I work|professional|doctor|engineer|specialist|expert)\b/i.test(c.body)).length;
                    const experienceCount = comments.filter(c => /\b(I |my |me |I've|I'm|personally)\b/i.test(c.body)).length;
                    const expertPct = Math.round((expertCount / comments.length) * 100);
                    const experiencePct = Math.round((experienceCount / comments.length) * 100);

                    let insight = expertPct >= 20 ?
                        `${expertPct}% expert/professional input, ${experiencePct}% firsthand experiences - balanced perspectives` :
                        `${experiencePct}% firsthand personal experiences - highly authentic discussion`;

                    insights.push({type: 'speaker_analysis', insight: insight});
                }

                if (analysisId === 'pricing_analysis') {
                    const priceComments = comments.filter(c => /\$[\d,]+|\bcost\b|\bprice\b|\bexpensive\b|\bcheap\b|\baffordable\b/i.test(c.body));
                    const expensiveMentions = priceComments.filter(c => /\bexpensive\b|\bpricey\b|\bcost\b|\$[\d,]{3,}/i.test(c.body)).length;
                    const cheapMentions = priceComments.filter(c => /\bcheap\b|\baffordable\b|\bbudget\b/i.test(c.body)).length;
                    const pricePct = Math.round((priceComments.length / comments.length) * 100);

                    insights.push({
                        type: 'pricing_analysis',
                        insight: `Price discussed in ${pricePct}% of comments - ${expensiveMentions > cheapMentions ? 'Quality over price' : 'Budget-conscious'} audience`
                    });
                }

                if (analysisId === 'timeline_analysis') {
                    const timeMentions = {};
                    const timePatterns = {
                        'immediate': /\b(immediately|instant|right away|same day)\b/i,
                        'days': /\b(days?|few days|couple days)\b/i,
                        'weeks': /\b(weeks?|few weeks)\b/i,
                        'months': /\b(months?|several months)\b/i,
                        'years': /\b(years?|long time|forever)\b/i
                    };

                    comments.forEach(c => {
                        Object.entries(timePatterns).forEach(([timeline, pattern]) => {
                            if (pattern.test(c.body)) timeMentions[timeline] = (timeMentions[timeline] || 0) + 1;
                        });
                    });

                    const dominant = Object.entries(timeMentions).sort((a, b) => b[1] - a[1])[0];
                    if (dominant && dominant[1] >= 3) {
                        const pct = Math.round((dominant[1] / comments.length) * 100);
                        insights.push({
                            type: 'timeline_analysis',
                            insight: `Most common timeline: "${dominant[0]}" (${pct}% of comments) - sets realistic expectations`
                        });
                    }
                }

                if (analysisId === 'consensus_analysis') {
                    const agreeCount = comments.filter(c => /\b(agree|exactly|this|same|correct|absolutely)\b/i.test(c.body)).length;
                    const disagreeCount = comments.filter(c => /\b(disagree|wrong|false|actually|but |however)\b/i.test(c.body)).length;
                    const controversyRatio = disagreeCount / (agreeCount + disagreeCount);
                    const controversyPct = Math.round(controversyRatio * 100);

                    if (controversyRatio > 0.4) {
                        insights.push({
                            type: 'consensus_analysis',
                            insight: `${controversyPct}% disagreement rate - Divisive topic with multiple conflicting viewpoints`
                        });
                        insights.push({
                            type: 'consensus_analysis',
                            insight: `Community split between perspectives - Deeper research needed to understand nuances`
                        });
                    } else {
                        insights.push({
                            type: 'consensus_analysis',
                            insight: `${100 - controversyPct}% consensus rate - Strong community agreement on key points`
                        });
                        insights.push({
                            type: 'consensus_analysis',
                            insight: `Unified perspective signals reliable information - Lower risk of misinformation`
                        });
                    }
                }

                if (analysisId === 'qa_analysis') {
                    const questionCount = comments.filter(c => /\?/.test(c.body)).length;
                    const answerCount = comments.filter(c => /\b(here's|this is|you should|try|check out|look at)\b/i.test(c.body)).length;
                    const qaRatio = answerCount / questionCount;

                    insights.push({
                        type: 'qa_analysis',
                        insight: `${questionCount} questions, ${answerCount} solution-oriented responses (${qaRatio.toFixed(1)}:1 ratio)`
                    });

                    if (qaRatio > 1.5) {
                        insights.push({
                            type: 'qa_analysis',
                            insight: `High answer-to-question ratio indicates helpful, solution-focused community`
                        });
                    } else {
                        insights.push({
                            type: 'qa_analysis',
                            insight: `Many unanswered questions - indicates emerging topic or knowledge gaps`
                        });
                    }
                }

                if (analysisId === 'evidence_analysis') {
                    const sourcedCount = comments.filter(c => /\b(source|study|research|according to|data shows)\b/i.test(c.body) || /https?:\/\//.test(c.body)).length;
                    const anecdotalCount = comments.filter(c => /\b(in my experience|I think|I feel|personally|IMO|IMHO)\b/i.test(c.body)).length;
                    const evidenceRatio = sourcedCount / (sourcedCount + anecdotalCount);
                    const evidencePct = Math.round(evidenceRatio * 100);

                    insights.push({
                        type: 'evidence_analysis',
                        insight: `${evidencePct}% evidence-based, ${100 - evidencePct}% opinion-based - ${evidencePct > 60 ? 'High credibility' : evidencePct > 40 ? 'Mixed credibility' : 'Mostly anecdotal'}`
                    });

                    if (evidencePct > 50) {
                        insights.push({
                            type: 'evidence_analysis',
                            insight: `Strong sourcing indicates trustworthy information - Can be cited with confidence`
                        });
                    } else {
                        insights.push({
                            type: 'evidence_analysis',
                            insight: `Opinion-heavy discussion - Verify claims independently before relying on them`
                        });
                    }
                }

                if (analysisId === 'comparison_analysis') {
                    const comparisons = [];
                    comments.forEach(c => {
                        const matches = (c.body || '').match(/([A-Za-z\s]+)\s+(vs|versus|compared to|better than|worse than|instead of)\s+([A-Za-z\s]+)/gi);
                        if (matches) matches.forEach(m => comparisons.push(m));
                    });

                    insights.push({
                        type: 'comparison_analysis',
                        insight: `${comparisons.length} comparison statements found - Active evaluation and decision-making`
                    });

                    if (comparisons.length > 0) {
                        const examples = comparisons.slice(0, 3).join(', ');
                        insights.push({
                            type: 'comparison_analysis',
                            insight: `Sample comparisons: ${examples.substring(0, 150)}...`
                        });
                    }

                    insights.push({
                        type: 'comparison_analysis',
                        insight: `Comparison-rich discussions indicate buyers/decision-makers seeking optimal choices`
                    });
                }

                if (analysisId === 'emotion_analysis') {
                    const positiveCount = comments.filter(c => /\b(love|excited|happy|grateful|amazing|fantastic|incredible)\b/i.test(c.body)).length;
                    const negativeCount = comments.filter(c => /\b(hate|angry|frustrated|disappointed|terrible|awful|horrible)\b/i.test(c.body)).length;
                    const neutralCount = comments.length - positiveCount - negativeCount;

                    const posPct = Math.round((positiveCount / comments.length) * 100);
                    const negPct = Math.round((negativeCount / comments.length) * 100);
                    const neuPct = Math.round((neutralCount / comments.length) * 100);

                    insights.push({
                        type: 'emotion_analysis',
                        insight: `Emotional breakdown: ${posPct}% positive, ${negPct}% negative, ${neuPct}% neutral`
                    });

                    if (posPct > negPct * 2) {
                        insights.push({
                            type: 'emotion_analysis',
                            insight: `Overwhelmingly positive tone - Strong community satisfaction and enthusiasm`
                        });
                    } else if (negPct > posPct * 2) {
                        insights.push({
                            type: 'emotion_analysis',
                            insight: `Predominantly negative tone - Significant frustration or disappointment present`
                        });
                    } else {
                        insights.push({
                            type: 'emotion_analysis',
                            insight: `Balanced emotional tone - Mature, objective discussion`
                        });
                    }
                }
            });

            return insights;
        }

        // ========================================================================
        // GENERATE DATA TABLES (for UI display)
        // ========================================================================

        function generateDataTables(data) {
            const comments = extractedData.valuableComments || [];
            const tables = [];

            // UNIVERSAL TABLE 1: Upvote Performance Tiers
            const tiers = [
                {name: 'Viral', min: 5000, comments: []},
                {name: 'High', min: 1000, max: 4999, comments: []},
                {name: 'Medium', min: 100, max: 999, comments: []},
                {name: 'Low', min: 0, max: 99, comments: []}
            ];

            comments.forEach((c, idx) => {
                const score = c.score || 0;
                if (score >= 5000) tiers[0].comments.push({...c, pos: idx + 1});
                else if (score >= 1000) tiers[1].comments.push({...c, pos: idx + 1});
                else if (score >= 100) tiers[2].comments.push({...c, pos: idx + 1});
                else tiers[3].comments.push({...c, pos: idx + 1});
            });

            const tierTableRows = tiers
                .filter(t => t.comments.length > 0)
                .map(t => {
                    const avgPos = Math.round(t.comments.reduce((sum, c) => sum + c.pos, 0) / t.comments.length);
                    const range = t.min === 5000 ? `${t.min}+` : `${t.min}-${t.max}`;
                    return `<tr>
                        <td><strong>${t.name}</strong></td>
                        <td>${range}</td>
                        <td>${t.comments.length}</td>
                        <td>#${avgPos}</td>
                    </tr>`;
                }).join('');

            if (tierTableRows) {
                tables.push({
                    title: 'üìä Upvote Performance Tiers',
                    html: `<table class="data-table">
                        <thead>
                            <tr><th>Tier</th><th>Range</th><th># Comments</th><th>Avg Position</th></tr>
                        </thead>
                        <tbody>${tierTableRows}</tbody>
                    </table>`
                });
            }

            // UNIVERSAL TABLE 2: Top 10 Comments Breakdown
            const top10 = comments.slice(0, Math.min(10, comments.length));
            if (top10.length > 0) {
                const top10Rows = top10.map((c, idx) => `<tr>
                    <td>${idx + 1}</td>
                    <td>u/${escapeHtml(c.author)}</td>
                    <td>${c.score}</td>
                    <td>${c.body.length} chars</td>
                    <td>${c.awards || 0}</td>
                </tr>`).join('');

                tables.push({
                    title: 'üèÜ Top 10 Comments Performance',
                    html: `<table class="data-table">
                        <thead>
                            <tr><th>Rank</th><th>Author</th><th>Upvotes</th><th>Length</th><th>Awards</th></tr>
                        </thead>
                        <tbody>${top10Rows}</tbody>
                    </table>`
                });
            }

            // UNIVERSAL TABLE 3: Word Count vs Engagement
            const wordCountBuckets = [
                {range: '1-50', min: 1, max: 50, comments: []},
                {range: '51-150', min: 51, max: 150, comments: []},
                {range: '151-300', min: 151, max: 300, comments: []},
                {range: '300+', min: 301, max: 999999, comments: []}
            ];

            comments.forEach(c => {
                const wordCount = (c.body || '').split(/\s+/).length;
                const bucket = wordCountBuckets.find(b => wordCount >= b.min && wordCount <= b.max);
                if (bucket) bucket.comments.push(c);
            });

            const wordCountRows = wordCountBuckets
                .filter(b => b.comments.length > 0)
                .map(b => {
                    const avgUpvotes = Math.round(b.comments.reduce((sum, c) => sum + (c.score || 0), 0) / b.comments.length);
                    const optimal = avgUpvotes === Math.max(...wordCountBuckets.map(x => x.comments.length > 0 ? Math.round(x.comments.reduce((s, c) => s + (c.score || 0), 0) / x.comments.length) : 0)) ? '‚úì' : '';
                    return `<tr>
                        <td>${b.range} words</td>
                        <td>${b.comments.length}</td>
                        <td>${avgUpvotes}</td>
                        <td>${optimal}</td>
                    </tr>`;
                }).join('');

            if (wordCountRows) {
                tables.push({
                    title: 'üìù Word Count vs Engagement',
                    html: `<table class="data-table">
                        <thead>
                            <tr><th>Range</th><th># Comments</th><th>Avg Upvotes</th><th>Optimal</th></tr>
                        </thead>
                        <tbody>${wordCountRows}</tbody>
                    </table>`
                });
            }

            // UNIVERSAL TABLE 4: Sentiment Distribution (if emotion analysis was selected)
            if (data.selectedAnalyses.includes('emotion_analysis')) {
                const positive = comments.filter(c => /\b(love|excited|happy|grateful|amazing|fantastic|incredible)\b/i.test(c.body));
                const negative = comments.filter(c => /\b(hate|angry|frustrated|disappointed|terrible|awful|horrible)\b/i.test(c.body));
                const neutral = comments.length - positive.length - negative.length;

                const avgPosUpvotes = positive.length > 0 ? Math.round(positive.reduce((s, c) => s + (c.score || 0), 0) / positive.length) : 0;
                const avgNegUpvotes = negative.length > 0 ? Math.round(negative.reduce((s, c) => s + (c.score || 0), 0) / negative.length) : 0;
                const avgNeuUpvotes = neutral > 0 ? Math.round(comments.filter(c => !positive.includes(c) && !negative.includes(c)).reduce((s, c) => s + (c.score || 0), 0) / neutral) : 0;

                tables.push({
                    title: 'üòä Sentiment Distribution',
                    html: `<table class="data-table">
                        <thead>
                            <tr><th>Sentiment</th><th># Comments</th><th>% of Total</th><th>Avg Upvotes</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>üòä Positive</td><td>${positive.length}</td><td>${Math.round(positive.length/comments.length*100)}%</td><td>${avgPosUpvotes}</td></tr>
                            <tr><td>üò† Negative</td><td>${negative.length}</td><td>${Math.round(negative.length/comments.length*100)}%</td><td>${avgNegUpvotes}</td></tr>
                            <tr><td>üòê Neutral</td><td>${neutral}</td><td>${Math.round(neutral/comments.length*100)}%</td><td>${avgNeuUpvotes}</td></tr>
                        </tbody>
                    </table>`
                });
            }

            // Content-specific table: Success Rates (if outcome_analysis selected)
            if (data.selectedAnalyses.includes('outcome_analysis')) {
                const worked = comments.filter(c => /\b(worked|success|helped|fixed|cured|solved)\b/i.test(c.body));
                const failed = comments.filter(c => /\b(failed|didn't work|worse|useless|no help)\b/i.test(c.body));

                if (worked.length + failed.length >= 5) {
                    const successRate = Math.round((worked.length / (worked.length + failed.length)) * 100);
                    tables.push({
                        title: '‚úÖ Success vs Failure Breakdown',
                        html: `<table class="data-table">
                            <thead>
                                <tr><th>Outcome</th><th># Comments</th><th>% of Total</th><th>Success Rate</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>‚úÖ Worked</td><td>${worked.length}</td><td>${Math.round(worked.length/comments.length*100)}%</td><td rowspan="2" style="font-size: 1.3em; font-weight: bold; vertical-align: middle;">${successRate}%</td></tr>
                                <tr><td>‚ùå Failed</td><td>${failed.length}</td><td>${Math.round(failed.length/comments.length*100)}%</td></tr>
                            </tbody>
                        </table>`
                    });
                }
            }

            return tables;
        }

        function displayStep3(data) {
            const container = document.getElementById('insightsContainer');
            container.style.display = 'block';

            const list = document.getElementById('insightsList');
            let html = '';

            // Check if this is AI-powered analysis
            if (data.mode === 'ai_analysis' && data.aiAnalysis) {
                // Display AI analysis with proper formatting
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                            <span>ü§ñ</span>
                            <span>AI-Powered Comprehensive Analysis</span>
                        </h3>
                        <p style="margin: 10px 0 0 0; opacity: 0.9; font-size: 0.9em;">
                            Powered by ${data.model || 'Gemini 1.5 Flash'}
                        </p>
                    </div>
                    <div style="background: white; padding: 30px; border-radius: 12px; border: 1px solid #e2e8f0; line-height: 1.8; color: #2d3748;">
                        ${formatMarkdown(data.aiAnalysis)}
                    </div>
                `;
            } else {
                // Original display for regex-based insights
                // Generate tables
                const tables = generateDataTables(data);

                // Display data tables first
                if (tables.length > 0) {
                    html += '<div style="margin-bottom: 30px;"><h3 style="color: #667eea; margin-bottom: 20px;">üìä Data Analysis</h3>';
                    tables.forEach(table => {
                        html += `<div style="margin-bottom: 30px;">
                            <h4 style="color: #4a5568; margin-bottom: 15px;">${table.title}</h4>
                            ${table.html}
                        </div>`;
                    });
                    html += '</div>';
                }

                // Display insights
                html += '<h3 style="color: #667eea; margin-bottom: 20px;">üí° Key Insights</h3>';
                html += data.insights.map(insight => `
                    <div class="insight-card">
                        <div class="insight-type">${escapeHtml(insight.type.replace(/_/g, ' '))}</div>
                        <div class="insight-text">üí° ${escapeHtml(insight.insight)}</div>
                    </div>
                `).join('');

                if (data.insights.length === 0) {
                    html = '<p style="text-align: center; color: #718096; padding: 40px;">No insights generated. Try selecting different analyses.</p>';
                }
            }

            list.innerHTML = html;

            // Scroll to insights
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Simple markdown formatter for AI analysis
        function formatMarkdown(text) {
            if (!text) return '';

            // Escape HTML first
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            // Format markdown
            html = html
                // Headers
                .replace(/^### (.*$)/gm, '<h3 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; font-size: 1.3em;">$1</h3>')
                .replace(/^## (.*$)/gm, '<h2 style="color: #5a67d8; margin-top: 35px; margin-bottom: 20px; font-size: 1.5em;">$1</h2>')
                .replace(/^# (.*$)/gm, '<h1 style="color: #4c51bf; margin-top: 40px; margin-bottom: 25px; font-size: 1.8em;">$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre style="background: #f7fafc; padding: 15px; border-radius: 8px; overflow-x: auto; border-left: 4px solid #667eea;"><code>$1</code></pre>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code style="background: #f7fafc; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #d53f8c;">$1</code>')
                // Bullet lists
                .replace(/^\‚Ä¢ (.*$)/gm, '<li style="margin-left: 20px;">$1</li>')
                .replace(/^- (.*$)/gm, '<li style="margin-left: 20px;">$1</li>')
                // Tables (markdown tables)
                .replace(/\n\|(.+)\|\n\|[-:\s|]+\|\n((?:\|.+\|\n?)+)/g, function(match, header, rows) {
                    let tableHtml = '<table class="data-table" style="width: 100%; border-collapse: collapse; margin: 20px 0;">';

                    // Header
                    const headers = header.split('|').map(h => h.trim()).filter(h => h);
                    tableHtml += '<thead><tr>';
                    headers.forEach(h => {
                        tableHtml += `<th style="background: #667eea; color: white; padding: 12px; text-align: left; border: 1px solid #e2e8f0;">${h}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';

                    // Rows
                    const rowLines = rows.trim().split('\n');
                    rowLines.forEach(row => {
                        const cells = row.split('|').map(c => c.trim()).filter(c => c);
                        if (cells.length > 0) {
                            tableHtml += '<tr>';
                            cells.forEach(cell => {
                                tableHtml += `<td style="padding: 12px; border: 1px solid #e2e8f0;">${cell}</td>`;
                            });
                            tableHtml += '</tr>';
                        }
                    });

                    tableHtml += '</tbody></table>';
                    return tableHtml;
                })
                // Line breaks
                .replace(/\n\n/g, '</p><p style="margin: 15px 0;">')
                .replace(/\n/g, '<br>');

            return '<p style="margin: 15px 0;">' + html + '</p>';
        }

        function collapseStep(stepId) {
            document.getElementById(stepId).style.display = 'none';
        }

        function startNewAnalysis() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('redditUrl').value = '';
            document.getElementById('redditUrl').focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function exportToPDF() {
            if (!extractedData) {
                alert('No data to export');
                return;
            }

            // Create a new window for PDF export
            const printWindow = window.open('', '', 'width=800,height=600');

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${escapeHtml(extractedData.post.title)}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        h1 {
                            color: #667eea;
                            font-size: 1.5em;
                            margin-bottom: 10px;
                        }
                        .meta {
                            color: #666;
                            font-size: 0.9em;
                            margin-bottom: 20px;
                        }
                        .stats {
                            background: #f5f5f5;
                            padding: 15px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                        }
                        .stat {
                            text-align: center;
                        }
                        .stat-value {
                            font-size: 1.5em;
                            font-weight: bold;
                            color: #667eea;
                        }
                        .stat-label {
                            font-size: 0.85em;
                            color: #666;
                        }
                        .comment {
                            border-left: 3px solid #667eea;
                            padding: 15px;
                            margin-bottom: 15px;
                            background: #f9f9f9;
                            page-break-inside: avoid;
                        }
                        .comment-meta {
                            font-size: 0.9em;
                            color: #666;
                            margin-bottom: 8px;
                        }
                        .comment-author {
                            font-weight: bold;
                            color: #667eea;
                        }
                        .comment-score {
                            color: #48bb78;
                            margin-left: 10px;
                        }
                        .comment-body {
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            color: #999;
                            font-size: 0.85em;
                        }
                        @media print {
                            body { margin: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìÑ ${escapeHtml(extractedData.post.title)}</h1>
                        <div class="meta">
                            Posted by u/${escapeHtml(extractedData.post.author)} ‚Ä¢
                            ${extractedData.post.score} upvotes ‚Ä¢
                            ${extractedData.post.num_comments} comments
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stats-grid">
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.total}</div>
                                <div class="stat-label">Total Comments</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.extracted}</div>
                                <div class="stat-label">High-Value Extracted</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.percentageKept}%</div>
                                <div class="stat-label">Kept</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.averageScore}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                        </div>
                    </div>

                    <h2 style="color: #667eea; margin-bottom: 15px;">Valuable Comments (${extractedData.valuableComments.length})</h2>

                    ${extractedData.valuableComments.map((comment, index) => `
                        <div class="comment">
                            <div class="comment-meta">
                                <span class="comment-author">#${index + 1} ‚Ä¢ u/${escapeHtml(comment.author)}</span>
                                <span class="comment-score">‚¨ÜÔ∏è ${comment.score}</span>
                                ${comment.awards > 0 ? `<span>üèÜ ${comment.awards}</span>` : ''}
                            </div>
                            <div class="comment-body">${escapeHtml(comment.body)}</div>
                        </div>
                    `).join('')}

                    <div class="footer">
                        Generated by Reddit Analyzer ‚Ä¢ ${new Date().toLocaleString()}
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();

            // Wait for content to load, then trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        // ========================================================================
        // FORMAT DATA FOR CLAUDE PRO (runs in browser - no backend call!)
        // ========================================================================

        function formatForClaudeAnalysis(data) {
            const post = data.post;
            const comments = data.valuableComments;
            const stats = data.extractionStats;

            // Build the formatted text with embedded prompt
            let output = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
REDDIT CONTENT ANALYSIS REQUEST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

You are an expert Reddit content analyst. Below is a Reddit post with extracted high-value comments. Provide deep, actionable insights that go beyond surface-level observations.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ANALYSIS FRAMEWORK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. CONTENT INTELLIGENCE
   ‚Ä¢ What type of discussion is this? (Don't force categories - describe what you observe)
   ‚Ä¢ What makes this content engaging to this audience?
   ‚Ä¢ What patterns emerge that might not be immediately obvious?

2. ENGAGEMENT DYNAMICS
   ‚Ä¢ Why did certain comments get high upvotes? What resonated?
   ‚Ä¢ Is there consensus, controversy, or something else driving engagement?
   ‚Ä¢ What's the upvote distribution telling us?

3. HIDDEN PATTERNS
   Look for non-obvious patterns:
   ‚Ä¢ Cognitive biases (confirmation bias, survivorship bias, etc.)
   ‚Ä¢ Emotional triggers (fear, hope, identity, validation)
   ‚Ä¢ Social dynamics (expertise vs experience, contrarian vs conformist)
   ‚Ä¢ Temporal patterns (immediate vs long-term thinking)
   ‚Ä¢ Economic factors (price sensitivity, value perception)

4. AUDIENCE INSIGHTS
   ‚Ä¢ Who is participating? (experts, enthusiasts, beginners, skeptics)
   ‚Ä¢ What do they care about? (practical advice, validation, entertainment, learning)
   ‚Ä¢ What assumptions do they share?
   ‚Ä¢ What questions are they really asking (vs what they explicitly say)?

5. CONTENT STRATEGY INTELLIGENCE
   If someone wanted to create similar engaging content:
   ‚Ä¢ What elements should they replicate?
   ‚Ä¢ What format works best? (question, story, controversy, education)
   ‚Ä¢ What tone resonates?
   ‚Ä¢ What timing/context matters?

6. SURPRISING FINDINGS
   ‚Ä¢ What's unexpected or counter-intuitive?
   ‚Ä¢ What would most people miss on first read?
   ‚Ä¢ What does this reveal about the community/topic/culture?

7. ACTIONABLE RECOMMENDATIONS
   Provide 3-5 specific, actionable takeaways for:
   ‚Ä¢ Content creators (how to replicate engagement)
   ‚Ä¢ Marketers (audience insights for targeting)
   ‚Ä¢ Researchers (cultural/social patterns)
   ‚Ä¢ The original poster (what they can learn)

8. DATA ANALYSIS WITH TABLES
   Generate data-driven tables that are RELEVANT to this specific content type.
   Choose 5-8 tables from these options based on what makes sense for THIS discussion:

   UNIVERSAL TABLES (apply to most posts):
   ‚Ä¢ Upvote Performance Tiers (Tier | Range | # Comments | Avg Position | Patterns)
   ‚Ä¢ Top 10-20 Comments Breakdown (Rank | Author | Upvotes | Theme | Key Factor)
   ‚Ä¢ Theme Distribution & Engagement (Theme | # Comments | Avg Upvotes | % of Discussion)
   ‚Ä¢ Word Count vs Engagement (Range | # Comments | Avg Upvotes | Optimal?)
   ‚Ä¢ Sentiment Distribution (Sentiment | # Comments | Avg Upvotes | Characteristics)

   CONTENT-SPECIFIC TABLES (choose relevant ones):
   For FACTUAL/TIL: Cognitive violations, verifiability matrix, temporal references
   For PRODUCT/REVIEW: Feature sentiment, price analysis, comparison matrix
   For OPINION/DEBATE: Viewpoint distribution, argument quality, polarization
   For ADVICE/HOW-TO: Success rates, expert vs experience, timeline expectations
   For STORY/EXPERIENCE: Emotional responses, advice vs empathy ratios

   TABLE GENERATION RULES:
   ‚Ä¢ Use markdown table format for easy reading
   ‚Ä¢ Include column headers and clear data
   ‚Ä¢ Add brief interpretation after each table
   ‚Ä¢ Only include tables that have sufficient data (minimum 5-10 data points)
   ‚Ä¢ Prioritize tables that reveal non-obvious insights
   ‚Ä¢ Calculate percentages, averages, and ratios where meaningful

IMPORTANT ANALYSIS GUIDELINES:
‚Ä¢ Don't just summarize - analyze WHY things are the way they are
‚Ä¢ Look for patterns across multiple comments, not just individual standouts
‚Ä¢ Consider context: subreddit culture, current events, audience demographics
‚Ä¢ Be honest if something is unclear or if the data is too limited
‚Ä¢ Cite specific examples from the comments to support your insights
‚Ä¢ Generate tables in markdown format for clarity
‚Ä¢ Choose 5-8 most relevant tables based on content type - don't force irrelevant tables

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
POST DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

TITLE: ${post.title}

METADATA:
‚Ä¢ Posted by: u/${post.author}
‚Ä¢ Subreddit: r/${post.subreddit || 'unknown'}
‚Ä¢ Post Score: ${post.score} upvotes
‚Ä¢ Total Comments: ${post.num_comments}

EXTRACTION STATISTICS:
‚Ä¢ Total Comments Processed: ${stats.total}
‚Ä¢ High-Value Comments Extracted: ${stats.extracted} (${stats.percentageKept}% kept)
‚Ä¢ Average Comment Score: ${stats.averageScore}
‚Ä¢ Extraction Quality: ${stats.percentageKept}% retention indicates ${stats.percentageKept > 50 ? 'diverse quality' : 'highly selective filtering'}

POST BODY:
${post.selftext || '[No body text - link or image post]'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
HIGH-VALUE COMMENTS (${comments.length} comments)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;

            // Add all comments
            comments.forEach((comment, index) => {
                output += `
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
COMMENT #${index + 1}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Author: u/${comment.author}
Score: ${comment.score} upvotes${comment.awards > 0 ? ` | Awards: ${comment.awards}` : ''}
Engagement Rank: #${index + 1} of ${comments.length}

${comment.body}
`;
            });

            output += `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
END OF DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Exported: ${new Date().toISOString()}
Analysis Tool: Reddit Analyzer v1.0

Now please provide your comprehensive analysis following the framework above.
`;

            return output;
        }

        // ========================================================================
        // DOWNLOAD FOR CLAUDE (no Drive permissions needed!)
        // ========================================================================

        function downloadForClaude(event) {
            if (!extractedData) {
                alert('No data to download. Please extract comments first.');
                return;
            }

            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Formatting...';
            btn.disabled = true;

            // Format content in browser (no backend call!)
            try {
                const formattedText = formatForClaudeAnalysis(extractedData);

                // Create download
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const postTitle = extractedData.post.title.substring(0, 50).replace(/[^a-z0-9]/gi, '_');
                const fileName = `Reddit_Analysis_${postTitle}_${timestamp}.txt`;

                const blob = new Blob([formattedText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Show success
                btn.innerHTML = '‚úÖ Downloaded!';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);

                showClaudeInstructions('download');
            } catch (error) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('‚ùå Failed to format content:\n\n' + error.message);
            }
        }

        // ========================================================================
        // COPY FOR CLAUDE (clipboard with embedded prompt)
        // ========================================================================

        function copyForClaude(event) {
            if (!extractedData) {
                alert('No data to copy. Please extract comments first.');
                return;
            }

            // Show loading state
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Formatting...';
            btn.disabled = true;

            // Format content in browser (no backend call!)
            try {
                const formattedText = formatForClaudeAnalysis(extractedData);

                // Copy to clipboard
                navigator.clipboard.writeText(formattedText)
                    .then(() => {
                        // Show success message
                        btn.innerHTML = '‚úÖ Copied!';
                        btn.disabled = false;
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2000);

                        // Show instructions
                        showClaudeInstructions('copy');
                    })
                    .catch(err => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                        alert('‚ùå Failed to copy to clipboard:\n\n' + err);
                    });
            } catch (error) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                alert('‚ùå Failed to format content:\n\n' + error.message);
            }
        }

        // ========================================================================
        // CLAUDE PRO INSTRUCTIONS
        // ========================================================================

        function showClaudeInstructions(mode = 'copy') {
            const instructions = mode === 'download' ? `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
HOW TO USE WITH CLAUDE PRO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STEP 1: Upload to Claude Pro
1. Go to claude.ai and start a new chat
2. Click the üìé attachment icon
3. Click "Upload from computer"
4. Select the file you just downloaded (in your Downloads folder)
5. Claude will automatically read the analysis prompt and provide insights!

ALTERNATIVE: Upload to Google Drive first
1. Upload the downloaded file to your Google Drive
2. In Claude Pro, click üìé ‚Üí "From Google Drive"
3. Select the uploaded file
4. Claude will analyze it automatically!

NOTE: The universal analysis prompt is already embedded in the file.
You don't need to write anything - Claude will automatically analyze it!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
` : `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
HOW TO USE WITH CLAUDE PRO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

STEP 1: Paste into Claude Pro
1. Go to claude.ai and start a new chat
2. Paste (Ctrl+V / Cmd+V) the copied content
3. Press Enter
4. Claude will automatically read the analysis prompt and provide insights!

NOTE: The universal analysis prompt is already embedded in the copied text.
You don't need to write anything - Claude will automatically analyze it!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;

            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            `;

            content.innerHTML = `
                <h2 style="color: #667eea; margin-bottom: 20px;">ü§ñ Use with Claude Pro</h2>
                <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.9em; line-height: 1.6; background: #f5f5f5; padding: 20px; border-radius: 5px; overflow-x: auto;">${escapeHtml(instructions)}</pre>
                <button onclick="this.closest('div').parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 20px; width: 100%;">Got it!</button>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
</body>
</html>
