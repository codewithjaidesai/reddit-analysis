<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Analyzer - 3-Step Interactive Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .input-section {
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 16px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #48bb78;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .loading {
            text-align: center;
            padding: 60px;
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .step-container {
            display: none;
            padding: 30px;
            border-bottom: 2px solid #eee;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .step-title {
            font-size: 1.5em;
            color: #1a202c;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #718096;
        }

        .comment-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .comment-card {
            background: #f9fafb;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .comment-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #718096;
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
        }

        .comment-score {
            color: #38a169;
        }

        .comment-body {
            color: #2d3748;
            white-space: pre-wrap;
        }

        .recommendations-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .recommendation-card {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recommendation-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .recommendation-card.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .recommendation-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recommendation-card.unavailable:hover {
            border-color: #e2e8f0;
            box-shadow: none;
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .recommendation-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #1a202c;
        }

        .recommendation-desc {
            color: #718096;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .recommendation-data {
            font-size: 0.85em;
            color: #48bb78;
            font-weight: 500;
        }

        .recommendation-estimate {
            font-size: 0.8em;
            color: #667eea;
            font-style: italic;
        }

        .insights-container {
            display: none;
            padding: 30px;
        }

        .insight-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .insight-type {
            font-size: 0.8em;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .insight-text {
            font-size: 1.1em;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .collapse-btn {
            background: #cbd5e0;
            color: #2d3748;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .collapse-btn:hover {
            background: #a0aec0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Reddit Analyzer</h1>
            <p>3-Step Interactive Analysis - Extract ‚Üí Recommend ‚Üí Analyze</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="redditUrl" placeholder="Paste Reddit post URL here..." value="https://www.reddit.com/r/AskReddit/comments/1hqxo9o/what_industry_is_quietly_booming_right_now_but/">
                <button class="btn" onclick="startAnalysis()">Step 1: Extract Content</button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingMessage">Extracting valuable content...</p>
        </div>

        <!-- STEP 1: Extracted Content -->
        <div class="step-container" id="step1Container">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Valuable Content Extracted</div>
            </div>

            <div class="stats-grid" id="extractionStats"></div>

            <div class="comment-list" id="commentList"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="proceedToStep2()">Step 2: Analyze & Recommend ‚Üí</button>
                <button class="btn" onclick="exportToPDF()" style="background: #ed8936;">üìÑ Export as PDF</button>
                <button class="btn collapse-btn" onclick="collapseStep('step1Container')">Collapse</button>
            </div>
        </div>

        <!-- STEP 2: Recommendations -->
        <div class="step-container" id="step2Container">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Available Analyses</div>
            </div>

            <p style="margin-bottom: 20px; color: #718096;">
                Based on the extracted content, here are the analyses we can run. Select which insights you want to generate:
            </p>

            <div class="recommendations-grid" id="recommendationsGrid"></div>

            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="proceedToStep3()" id="generateBtn" disabled>
                    Step 3: Generate Selected Insights ‚Üí
                </button>
                <button class="btn collapse-btn" onclick="collapseStep('step2Container')">Collapse</button>
            </div>
        </div>

        <!-- STEP 3: Insights -->
        <div class="insights-container" id="insightsContainer">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Strategic Insights</div>
            </div>

            <div id="insightsList"></div>

            <div class="action-buttons">
                <button class="btn" onclick="startNewAnalysis()">Analyze Another Post</button>
            </div>
        </div>
    </div>

    <script>
        // Google Apps Script web app URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwLPQgHXv8RFFYDQS_eoEMoTOQp8gptNIUi9wJgvC-wK9WQI5XHn8yAVaH95WZR9WsP/exec';

        let extractedData = null;
        let selectedAnalyses = new Set();

        function startAnalysis() {
            const url = document.getElementById('redditUrl').value.trim();
            if (!url) {
                alert('Please enter a Reddit URL');
                return;
            }

            // Reset
            document.getElementById('step1Container').style.display = 'none';
            document.getElementById('step2Container').style.display = 'none';
            document.getElementById('insightsContainer').style.display = 'none';
            extractedData = null;
            selectedAnalyses.clear();

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Extracting valuable content from comments...';

            // Call Step 1: Extract
            const callbackName = 'callback_' + Date.now();
            window[callbackName] = function(response) {
                document.getElementById('loading').style.display = 'none';

                if (response.success) {
                    extractedData = response.data;
                    displayStep1(response.data);
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }

                delete window[callbackName];
            };

            const scriptElement = document.createElement('script');
            scriptElement.src = `${SCRIPT_URL}?url=${encodeURIComponent(url)}&mode=step1_extract&callback=${callbackName}`;
            document.body.appendChild(scriptElement);
        }

        function displayStep1(data) {
            const container = document.getElementById('step1Container');
            container.style.display = 'block';

            // Display post title
            const postTitle = document.createElement('div');
            postTitle.style.cssText = 'background: #eef2ff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;';
            postTitle.innerHTML = `
                <div style="font-size: 1.2em; font-weight: 600; color: #1a202c; margin-bottom: 10px;">
                    üìÑ ${escapeHtml(data.post.title)}
                </div>
                <div style="font-size: 0.9em; color: #718096;">
                    Posted by u/${escapeHtml(data.post.author)} ‚Ä¢ ${data.post.score} upvotes ‚Ä¢ ${data.post.num_comments} comments
                </div>
            `;
            document.getElementById('step1Container').insertBefore(postTitle, document.getElementById('extractionStats'));

            // Display stats
            const stats = data.extractionStats;
            document.getElementById('extractionStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total}</div>
                    <div class="stat-label">Total Comments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.extracted}</div>
                    <div class="stat-label">High-Value Extracted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.percentageKept}%</div>
                    <div class="stat-label">Kept</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.averageScore}</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            `;

            // Display comments
            const commentList = document.getElementById('commentList');
            commentList.innerHTML = data.valuableComments.map(comment => `
                <div class="comment-card">
                    <div class="comment-meta">
                        <span class="comment-author">üë§ u/${escapeHtml(comment.author)}</span>
                        <span class="comment-score">‚¨ÜÔ∏è ${comment.score}</span>
                        ${comment.awards > 0 ? `<span>üèÜ ${comment.awards}</span>` : ''}
                    </div>
                    <div class="comment-body">${escapeHtml(comment.body.substring(0, 400))}${comment.body.length > 400 ? '...' : ''}</div>
                </div>
            `).join('');

            // Scroll to step 1
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function proceedToStep2() {
            if (!extractedData) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Analyzing content and generating recommendations...';

            const callbackName = 'callback_' + Date.now();
            window[callbackName] = function(response) {
                document.getElementById('loading').style.display = 'none';

                if (response.success) {
                    displayStep2(response.data);
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }

                delete window[callbackName];
            };

            const scriptElement = document.createElement('script');
            const url = document.getElementById('redditUrl').value.trim();
            scriptElement.src = `${SCRIPT_URL}?url=${encodeURIComponent(url)}&mode=step2_recommend&callback=${callbackName}`;
            document.body.appendChild(scriptElement);
        }

        function displayStep2(data) {
            const container = document.getElementById('step2Container');
            container.style.display = 'block';

            const grid = document.getElementById('recommendationsGrid');
            grid.innerHTML = data.recommendations.map(rec => `
                <div class="recommendation-card ${rec.available ? '' : 'unavailable'}"
                     onclick="${rec.available ? `toggleAnalysis('${rec.id}')` : ''}"
                     id="rec_${rec.id}">
                    <div class="recommendation-header">
                        ${rec.available ? `<input type="checkbox" class="checkbox" id="check_${rec.id}" onchange="updateSelection()">` : ''}
                        <div class="recommendation-title">${rec.available ? '‚úì' : '‚úó'} ${escapeHtml(rec.name)}</div>
                    </div>
                    <div class="recommendation-desc">${escapeHtml(rec.description)}</div>
                    <div class="recommendation-data">üìä ${escapeHtml(rec.dataFound)}</div>
                    ${rec.available ? `<div class="recommendation-estimate">~${rec.estimatedInsights} insights expected</div>` : ''}
                </div>
            `).join('');

            // Scroll to step 2
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function toggleAnalysis(analysisId) {
            const checkbox = document.getElementById('check_' + analysisId);
            const card = document.getElementById('rec_' + analysisId);

            if (checkbox.checked) {
                selectedAnalyses.delete(analysisId);
                checkbox.checked = false;
                card.classList.remove('selected');
            } else {
                selectedAnalyses.add(analysisId);
                checkbox.checked = true;
                card.classList.add('selected');
            }

            updateSelection();
        }

        function updateSelection() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = selectedAnalyses.size === 0;
            btn.textContent = `Step 3: Generate ${selectedAnalyses.size} Selected Insight${selectedAnalyses.size !== 1 ? 's' : ''} ‚Üí`;
        }

        function proceedToStep3() {
            if (selectedAnalyses.size === 0 || !extractedData) return;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadingMessage').textContent = 'Generating selected insights...';

            const callbackName = 'callback_' + Date.now();
            window[callbackName] = function(response) {
                document.getElementById('loading').style.display = 'none';

                if (response.success) {
                    displayStep3(response.data);
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }

                delete window[callbackName];
            };

            const scriptElement = document.createElement('script');
            const url = document.getElementById('redditUrl').value.trim();
            const selectedParam = encodeURIComponent(JSON.stringify(Array.from(selectedAnalyses)));
            scriptElement.src = `${SCRIPT_URL}?url=${encodeURIComponent(url)}&mode=step3_analyze&selectedAnalyses=${selectedParam}&callback=${callbackName}`;
            document.body.appendChild(scriptElement);
        }

        function displayStep3(data) {
            const container = document.getElementById('insightsContainer');
            container.style.display = 'block';

            const list = document.getElementById('insightsList');
            list.innerHTML = data.insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-type">${escapeHtml(insight.type.replace(/_/g, ' '))}</div>
                    <div class="insight-text">üí° ${escapeHtml(insight.insight)}</div>
                </div>
            `).join('');

            if (data.insights.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No insights generated. Try selecting different analyses.</p>';
            }

            // Scroll to insights
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function collapseStep(stepId) {
            document.getElementById(stepId).style.display = 'none';
        }

        function startNewAnalysis() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            document.getElementById('redditUrl').value = '';
            document.getElementById('redditUrl').focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function exportToPDF() {
            if (!extractedData) {
                alert('No data to export');
                return;
            }

            // Create a new window for PDF export
            const printWindow = window.open('', '', 'width=800,height=600');

            const html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${escapeHtml(extractedData.post.title)}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 20px;
                            color: #333;
                        }
                        .header {
                            border-bottom: 3px solid #667eea;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        h1 {
                            color: #667eea;
                            font-size: 1.5em;
                            margin-bottom: 10px;
                        }
                        .meta {
                            color: #666;
                            font-size: 0.9em;
                            margin-bottom: 20px;
                        }
                        .stats {
                            background: #f5f5f5;
                            padding: 15px;
                            border-radius: 5px;
                            margin-bottom: 20px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(4, 1fr);
                            gap: 15px;
                        }
                        .stat {
                            text-align: center;
                        }
                        .stat-value {
                            font-size: 1.5em;
                            font-weight: bold;
                            color: #667eea;
                        }
                        .stat-label {
                            font-size: 0.85em;
                            color: #666;
                        }
                        .comment {
                            border-left: 3px solid #667eea;
                            padding: 15px;
                            margin-bottom: 15px;
                            background: #f9f9f9;
                            page-break-inside: avoid;
                        }
                        .comment-meta {
                            font-size: 0.9em;
                            color: #666;
                            margin-bottom: 8px;
                        }
                        .comment-author {
                            font-weight: bold;
                            color: #667eea;
                        }
                        .comment-score {
                            color: #48bb78;
                            margin-left: 10px;
                        }
                        .comment-body {
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        }
                        .footer {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #ddd;
                            text-align: center;
                            color: #999;
                            font-size: 0.85em;
                        }
                        @media print {
                            body { margin: 15px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìÑ ${escapeHtml(extractedData.post.title)}</h1>
                        <div class="meta">
                            Posted by u/${escapeHtml(extractedData.post.author)} ‚Ä¢
                            ${extractedData.post.score} upvotes ‚Ä¢
                            ${extractedData.post.num_comments} comments
                        </div>
                    </div>

                    <div class="stats">
                        <div class="stats-grid">
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.total}</div>
                                <div class="stat-label">Total Comments</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.extracted}</div>
                                <div class="stat-label">High-Value Extracted</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.percentageKept}%</div>
                                <div class="stat-label">Kept</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${extractedData.extractionStats.averageScore}</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                        </div>
                    </div>

                    <h2 style="color: #667eea; margin-bottom: 15px;">Valuable Comments (${extractedData.valuableComments.length})</h2>

                    ${extractedData.valuableComments.map((comment, index) => `
                        <div class="comment">
                            <div class="comment-meta">
                                <span class="comment-author">#${index + 1} ‚Ä¢ u/${escapeHtml(comment.author)}</span>
                                <span class="comment-score">‚¨ÜÔ∏è ${comment.score}</span>
                                ${comment.awards > 0 ? `<span>üèÜ ${comment.awards}</span>` : ''}
                            </div>
                            <div class="comment-body">${escapeHtml(comment.body)}</div>
                        </div>
                    `).join('')}

                    <div class="footer">
                        Generated by Reddit Analyzer ‚Ä¢ ${new Date().toLocaleString()}
                    </div>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();

            // Wait for content to load, then trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
    </script>
</body>
</html>
